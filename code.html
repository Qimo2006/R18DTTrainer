<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DT Training - Interactive Sensing Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow-x: hidden;
            user-select: none;
        }

        /* éšè—çš„æ‘„åƒå¤´å…ƒç´  */
        #video, #canvas {
            display: none;
        }

        /* å¤´éƒ¨ä¿¡æ¯æ  */
        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none; /* æ¸¸æˆå¼€å§‹å‰éšè— */
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* ä¸»æ¸¸æˆåŒºåŸŸ */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        /* æ¸¸æˆæ¨¡å¼é€‰æ‹©ç•Œé¢ */
        .mode-selection {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        .mode-selection .game-title {
            text-align: center;
            font-size: 42px;
            margin-bottom: 40px;
            display: block;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* æ¸¸æˆæ¨¡å¼æŒ‰é’® - æ¸å˜è“è‰² */
        .mode-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .mode-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .mode-btn:hover:before {
            left: 100%;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-description {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* åˆ‡æ¢æ¨¡å¼æŒ‰é’® - æ¸å˜ç»¿è‰² */
        .toggle-btn {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            border: none;
            color: white;
            padding: 18px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            width: 100%;
        }

        .toggle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* è®¾ç½®æŒ‰é’® - æ¸å˜ç´«è‰² */
        .settings-btn {
            background: linear-gradient(135deg, #ee0979, #ff6a00);
            border: none;
            color: white;
            padding: 18px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
        }

        .settings-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* è®¾ç½®ç•Œé¢ */
        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
            display: none;
        }

        .settings-panel h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .setting-item {
            margin-bottom: 25px;
        }

        .setting-label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            opacity: 0.9;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            transition: opacity 0.2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #ffd700;
        }

        .sensor-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .sensor-info h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #ffd700;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .info-label {
            opacity: 0.8;
        }

        .info-value {
            font-weight: bold;
            color: #4caf50;
        }

        .brightness-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .brightness-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
        }

        /* æ¸¸æˆè®¾ç½®å¼¹çª— */
        .game-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .game-settings-modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            border-radius: 20px;
            padding: 40px;
            max-width: 700px;
            width: 95%;
            max-height: 85vh;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .modal-header p {
            opacity: 0.8;
            font-size: 14px;
        }

        .modal-settings {
            margin-bottom: 40px;
        }

        .modal-setting-item {
            margin-bottom: 25px;
        }

        .modal-setting-label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .modal-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .modal-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .modal-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .modal-input-hint {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .preset-btn.unlimited {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            font-weight: bold;
            border: 1px solid rgba(255, 215, 0, 0.5);
        }

        .preset-btn.unlimited:hover {
            background: linear-gradient(135deg, #ffed4e, #ffd700);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-area {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            animation: fadeIn 0.5s ease-out;
            width: 100%;
            height: 100vh;
            justify-content: center;
        }

        /* æ¸¸æˆä¸­çš„åˆ†æ•°æ˜¾ç¤º */
        .game-score {
            font-size: 80px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            animation: scoreGlow 2s ease-in-out infinite alternate;
            margin-bottom: 20px;
        }

        @keyframes scoreGlow {
            from {
                text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
            to {
                text-shadow: 0 0 50px rgba(255, 215, 0, 1);
            }
        }

        .sensor-visual {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .sensor-visual.near {
            border-color: #4caf50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
            animation: pulse 1s infinite;
        }

        .sensor-visual.far {
            border-color: #2196f3;
            box-shadow: 0 0 30px rgba(33, 150, 243, 0.6);
        }

        .sensor-visual.scoring {
            border-color: #ffd700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .sensor-status {
            font-size: 18px;
            text-align: center;
        }

        .state-indicator {
            margin-top: 10px;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            font-size: 14px;
        }

        .progress-bar {
            width: 300px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .combo-indicator {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }

        .combo-indicator.show {
            animation: comboPopup 1s ease-out;
        }

        @keyframes comboPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            position: absolute;
            bottom: 30px;
            z-index: 100; /* ç¡®ä¿æŒ‰é’®åœ¨æœ€ä¸Šå±‚ */
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            z-index: 101; /* ç¡®ä¿æŒ‰é’®å¯ç‚¹å‡» */
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border: none;
        }

        /* æ¸¸æˆç»“æŸç•Œé¢ */
        .game-over {
            display: none;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 60px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
            max-width: 600px;
            width: 90%;
        }

        .game-over h2 {
            font-size: 48px;
            margin-bottom: 30px;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        .final-score {
            font-size: 72px;
            font-weight: bold;
            margin: 30px 0;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            color: #ffd700;
        }

        .game-stats {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 18px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .stat-name {
            opacity: 0.8;
        }

        .stat-value-large {
            font-size: 24px;
            font-weight: bold;
            color: #4caf50;
        }

        .high-score {
            font-size: 20px;
            opacity: 0.9;
            margin-bottom: 30px;
            color: #ffd700;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç²’å­æ•ˆæœ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .mode-selection .game-title {
                font-size: 32px;
            }

            .mode-selection, .settings-panel {
                padding: 30px 20px;
            }

            .sensor-visual {
                width: 150px;
                height: 150px;
            }

            .progress-bar {
                width: 250px;
            }

            .game-score {
                font-size: 60px;
            }

            .modal-content {
                padding: 30px 20px;
            }

            .game-over {
                padding: 40px 20px;
            }

            .game-over h2 {
                font-size: 36px;
            }

            .final-score {
                font-size: 56px;
            }
        }

        /* è§¦ç¢°æ¨¡å¼è¦†ç›–å±‚ */
        .touch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            display: none;
        }

        .touch-overlay.active {
            display: block;
        }

        /* è¯­è¨€é€‰æ‹©å™¨ */
        .language-selector {
            margin-bottom: 20px;
        }

        .language-select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .language-select option {
            background: #333;
            color: white;
        }
    </style>
</head>
<body>
    <!-- éšè—çš„æ‘„åƒå¤´å…ƒç´  -->
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <!-- è§¦ç¢°æ¨¡å¼è¦†ç›–å±‚ -->
    <div class="touch-overlay" id="touchOverlay"></div>

    <!-- ç²’å­èƒŒæ™¯ -->
    <div class="particles" id="particles"></div>

    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <header id="gameHeader">
        <div class="header-content">
            <h1 class="game-title">ğŸ® DT Training</h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label" data-i18n="time">Time</span>
                    <span class="stat-value" id="timer">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
    <main>
        <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹© -->
        <section class="mode-selection" id="modeSelection">
            <h1 class="game-title">ğŸ® DT Training</h1>
            <div class="mode-buttons">
                <button class="mode-btn" onclick="showGameSettings('timeAttack')">
                    â±ï¸ <span data-i18n="timeAttack">Time Attack</span>
                    <div class="mode-description" data-i18n="timeAttackDesc">Get as many counts as possible within the time limit</div>
                </button>
                <button class="mode-btn" onclick="showGameSettings('endurance')">
                    ğŸ’ª <span data-i18n="endurance">Endurance Mode</span>
                    <div class="mode-description" data-i18n="enduranceDesc">Maintain near-far cycles and complete the specified count</div>
                </button>
            </div>
            <button class="toggle-btn" onclick="toggleSensorMode()">
                ğŸ”„ <span data-i18n="currentMode">Current Mode:</span> <span id="currentModeText">Light Sensor Mode</span>
            </button>
            <button class="settings-btn" onclick="showSettings()">
                âš™ï¸ <span data-i18n="settings">Game Settings</span>
            </button>
        </section>

        <!-- è®¾ç½®ç•Œé¢ -->
        <section class="settings-panel" id="settingsPanel">
            <h2 data-i18n="gameSettings">âš™ï¸ Game Settings</h2>
            
            <div class="setting-item">
                <label class="setting-label" data-i18n="language">Language</label>
                <select class="language-select" id="languageSelect" onchange="changeLanguage()">
                    <option value="en">English</option>
                    <option value="zh">ä¸­æ–‡</option>
                </select>
            </div>
            
            <div class="setting-item">
                <label class="setting-label" data-i18n="proximityThreshold">Proximity Threshold (lower value = more sensitive)</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="thresholdSlider" min="30" max="300" value="90">
                    <span class="slider-value" id="thresholdValue">90</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label" data-i18n="stableTime">Stable Time (milliseconds)</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="stableTimeSlider" min="300" max="2000" value="1000" step="100">
                    <span class="slider-value" id="stableTimeValue">1000</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label" data-i18n="invertSensor">Invert Light Sensor (recommended for mobile)</label>
                <div class="checkbox-container">
                    <input type="checkbox" class="checkbox" id="invertSensor">
                    <span data-i18n="invertSensorDesc">When enabled, high light intensity means near, low means far</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label" data-i18n="autoFullscreen">Auto Fullscreen on Game Start</label>
                <div class="checkbox-container">
                    <input type="checkbox" class="checkbox" id="autoFullscreen">
                    <span data-i18n="autoFullscreenDesc">Automatically enter fullscreen mode when game starts</span>
                </div>
            </div>

            <div class="sensor-info" id="sensorInfo">
                <h3 data-i18n="realtimeSensorInfo">ğŸ“Š Real-time Sensor Information</h3>
                <div class="info-row">
                    <span class="info-label" data-i18n="currentBrightness">Current Brightness:</span>
                    <span class="info-value" id="currentBrightness">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-i18n="smoothedBrightness">Smoothed Brightness:</span>
                    <span class="info-value" id="smoothedBrightness">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label" data-i18n="detectionStatus">Detection Status:</span>
                    <span class="info-value" id="detectionStatus">Not Started</span>
                </div>
                <div class="brightness-bar">
                    <div class="brightness-fill" id="brightnessFill"></div>
                </div>
            </div>

            <div class="controls" style="position: relative; margin-top: 50px;">
                <button class="control-btn primary" onclick="saveSettings()" data-i18n="saveSettings">Save Settings</button>
                <button class="control-btn" onclick="backToMenu()" data-i18n="backToMenu">Back to Menu</button>
            </div>
        </section>

        <!-- æ¸¸æˆè®¾ç½®å¼¹çª— -->
        <div class="game-settings-modal" id="gameSettingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle" data-i18n="gameSettings">Game Settings</h2>
                    <p id="modalDescription" data-i18n="adjustGameParams">Adjust game parameters</p>
                </div>
                <div class="modal-settings" id="modalSettings">
                    <!-- åŠ¨æ€ç”Ÿæˆè®¾ç½®é¡¹ -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeGameSettings()" data-i18n="cancel">Cancel</button>
                    <button class="modal-btn primary" onclick="startGameWithSettings()" data-i18n="startGame">Start Game</button>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <section class="game-area" id="gameArea">
            <div class="game-score" id="gameScore">0</div>
            <div class="sensor-visual" id="sensorVisual">
                <div>
                    <div class="sensor-status" id="sensorStatus" data-i18n="ready">Ready</div>
                    <div class="state-indicator" id="stateIndicator" data-i18n="waitForNear">Wait for Near</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="combo-indicator" id="comboIndicator"></div>

            <div class="controls">
                <button class="control-btn" onclick="pauseGame()" data-i18n="pause">Pause</button>
                <button class="control-btn primary" onclick="backToMenu()" data-i18n="backToMenu">Back to Menu</button>
            </div>
        </section>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <section class="game-over" id="gameOver">
            <h2 data-i18n="gameOver">Game Over!</h2>
            <div class="final-score" id="finalScore">0</div>
            <div class="game-stats">
                <div class="stat-row">
                    <span class="stat-name" data-i18n="gameMode">Game Mode:</span>
                    <span id="gameModeText">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name" data-i18n="completedCycles">Completed Cycles:</span>
                    <span id="cycleCountText">-</span>
                </div>
                <div class="stat-row">
                    <span class="stat-name" id="timeLabel" data-i18n="timeUsed">Time Used:</span>
                    <span id="timeUsedText">-</span>
                </div>
            </div>
            <div class="high-score" id="highScore">Highest Count: 0</div>
            <div class="controls">
                <button class="control-btn primary" onclick="restartGame()" data-i18n="playAgain">Play Again</button>
                <button class="control-btn" onclick="backToMenu()" data-i18n="backToMenu">Back to Menu</button>
            </div>
        </section>
    </main>

    <script>
        // ===================================================================
        // å›½é™…åŒ–æ–‡æœ¬
        // ===================================================================
        const i18n = {
            en: {
                // é€šç”¨
                time: "Time",
                settings: "Game Settings",
                backToMenu: "Back to Menu",
                saveSettings: "Save Settings",
                cancel: "Cancel",
                startGame: "Start Game",
                pause: "Pause",
                playAgain: "Play Again",
                gameMode: "Game Mode",
                completedCycles: "Completed Cycles",
                timeUsed: "Time Used",
                remainingTime: "Remaining Time",
                highestCount: "Highest Count",
                gameOver: "Game Over!",
                ready: "Ready",
                waitForNear: "Wait for Near",
                keepNear: "Keep Near",
                pleaseFar: "Please Move Away",
                detecting: "Detecting...",
                waitForNear: "Wait for Near",
                currentMode: "Current Mode:",
                language: "Language",
                
                // æ¸¸æˆæ¨¡å¼
                timeAttack: "Time Attack",
                timeAttackDesc: "Get as many counts as possible within the time limit",
                endurance: "Endurance Mode",
                enduranceDesc: "Maintain near-far cycles and complete the specified count",
                
                // è®¾ç½®
                proximityThreshold: "Proximity Threshold (lower value = more sensitive)",
                stableTime: "Stable Time (milliseconds)",
                invertSensor: "Invert Light Sensor (recommended for mobile)",
                invertSensorDesc: "When enabled, high light intensity means near, low means far",
                autoFullscreen: "Auto Fullscreen on Game Start",
                autoFullscreenDesc: "Automatically enter fullscreen mode when game starts",
                realtimeSensorInfo: "ğŸ“Š Real-time Sensor Information",
                currentBrightness: "Current Brightness:",
                smoothedBrightness: "Smoothed Brightness:",
                detectionStatus: "Detection Status:",
                notStarted: "Not Started",
                detectedNear: "Near Detected",
                notDetected: "Not Detected",
                
                // æ¨¡å¼ç‰¹å®š
                timeLimit: "Time Limit (seconds)",
                targetCount: "Target Count",
                maxCycles: "Maximum Cycles",
                unlimited: "Unlimited",
                range: "Range:",
                secondsToHour: "5 seconds - 1 hour",
                countRange: "10 counts - 999999 counts",
                cyclesRange: "1 cycle - 1000 cycles",
                
                // æ—¶é—´å•ä½
                sec: "sec",
                min: "min",
                hour: "hour",
                seconds: "seconds",
                minutes: "minutes",
                
                // æ„Ÿåº”æ¨¡å¼
                lightSensorMode: "Light Sensor Mode",
                touchMode: "Touch Mode",
                adjustGameParams: "Adjust game parameters",
                
                // çŠ¶æ€
                timeAttackMode: "Time Attack",
                enduranceMode: "Endurance Mode",
                cycles: "cycles",
                count: "count"
            },
            zh: {
                // é€šç”¨
                time: "æ—¶é—´",
                settings: "æ¸¸æˆè®¾ç½®",
                backToMenu: "è¿”å›èœå•",
                saveSettings: "ä¿å­˜è®¾ç½®",
                cancel: "å–æ¶ˆ",
                startGame: "å¼€å§‹æ¸¸æˆ",
                pause: "æš‚åœ",
                playAgain: "å†ç©ä¸€æ¬¡",
                gameMode: "æ¸¸æˆæ¨¡å¼",
                completedCycles: "å®Œæˆæ¬¡æ•°",
                timeUsed: "ä½¿ç”¨æ—¶é—´",
                remainingTime: "å‰©ä½™æ—¶é—´",
                highestCount: "æœ€é«˜æ¬¡æ•°",
                gameOver: "æ¸¸æˆç»“æŸï¼",
                ready: "å‡†å¤‡å°±ç»ª",
                waitForNear: "ç­‰å¾…é è¿‘",
                keepNear: "ä¿æŒé è¿‘",
                pleaseFar: "è¯·è¿œç¦»",
                detecting: "æ£€æµ‹ä¸­...",
                waitForNear: "ç­‰å¾…é è¿‘",
                currentMode: "å½“å‰æ¨¡å¼:",
                language: "è¯­è¨€",
                
                // æ¸¸æˆæ¨¡å¼
                timeAttack: "é™æ—¶æŒ‘æˆ˜",
                timeAttackDesc: "åœ¨é™å®šæ—¶é—´å†…è·å¾—å°½å¯èƒ½é«˜çš„æ¬¡æ•°",
                endurance: "è€åŠ›æ¨¡å¼",
                enduranceDesc: "ä¿æŒé è¿‘-è¿œç¦»å¾ªç¯ï¼Œå®ŒæˆæŒ‡å®šæ¬¡æ•°",
                
                // è®¾ç½®
                proximityThreshold: "é è¿‘é˜ˆå€¼ (äº®åº¦å€¼è¶Šä½è¶Šæ•æ„Ÿ)",
                stableTime: "ç¨³å®šæ—¶é—´ (æ¯«ç§’)",
                invertSensor: "åè½¬æ„Ÿå…‰ (æ‰‹æœºç«¯æ¨è)",
                invertSensorDesc: "å¼€å¯åï¼Œé è¿‘æ—¶å…‰å¼ºé«˜ï¼Œè¿œç¦»æ—¶å…‰å¼ºä½",
                autoFullscreen: "å¼€å§‹æ¸¸æˆè‡ªåŠ¨å…¨å±",
                autoFullscreenDesc: "æ¸¸æˆå¼€å§‹æ—¶è‡ªåŠ¨è¿›å…¥å…¨å±æ¨¡å¼",
                realtimeSensorInfo: "ğŸ“Š å®æ—¶æ„Ÿå…‰ä¿¡æ¯",
                currentBrightness: "å½“å‰äº®åº¦:",
                smoothedBrightness: "å¹³æ»‘äº®åº¦:",
                detectionStatus: "æ£€æµ‹çŠ¶æ€:",
                notStarted: "æœªå¼€å§‹",
                detectedNear: "æ£€æµ‹åˆ°é è¿‘",
                notDetected: "æœªæ£€æµ‹åˆ°",
                
                // æ¨¡å¼ç‰¹å®š
                timeLimit: "é™æ—¶æ—¶é—´ (ç§’)",
                targetCount: "ç›®æ ‡æ¬¡æ•°",
                maxCycles: "æœ€å¤§å¾ªç¯æ¬¡æ•°",
                unlimited: "æ— ä¸Šé™",
                range: "èŒƒå›´ï¼š",
                secondsToHour: "5ç§’ - 1å°æ—¶",
                countRange: "10æ¬¡ - 999999æ¬¡",
                cyclesRange: "1æ¬¡ - 1000æ¬¡",
                
                // æ—¶é—´å•ä½
                sec: "ç§’",
                min: "åˆ†",
                hour: "å°æ—¶",
                seconds: "ç§’",
                minutes: "åˆ†",
                
                // æ„Ÿåº”æ¨¡å¼
                lightSensorMode: "å…‰æ„Ÿæ¨¡å¼",
                touchMode: "è§¦ç¢°æ¨¡å¼",
                adjustGameParams: "è°ƒæ•´æ¸¸æˆå‚æ•°",
                
                // çŠ¶æ€
                timeAttackMode: "é™æ—¶æŒ‘æˆ˜",
                enduranceMode: "è€åŠ›æ¨¡å¼",
                cycles: "æ¬¡",
                count: "æ¬¡"
            }
        };

        // å½“å‰è¯­è¨€
        let currentLanguage = 'en';

        // ===================================================================
        // Cookie å·¥å…·å‡½æ•°
        // ===================================================================
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/`;
        }

        // ===================================================================
        // å›½é™…åŒ–å‡½æ•°
        // ===================================================================
        function changeLanguage() {
            const select = document.getElementById('languageSelect');
            currentLanguage = select.value;
            setCookie('language', currentLanguage, 365);
            updateLanguage();
        }

        function updateLanguage() {
            // æ›´æ–°æ‰€æœ‰å¸¦æœ‰ data-i18n å±æ€§çš„å…ƒç´ 
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (i18n[currentLanguage] && i18n[currentLanguage][key]) {
                    element.textContent = i18n[currentLanguage][key];
                }
            });
            
            // æ›´æ–°ç‰¹æ®Šå…ƒç´ 
            updateSpecialElements();
        }

        function updateSpecialElements() {
            // æ›´æ–°å½“å‰æ¨¡å¼æ–‡æœ¬
            document.getElementById('currentModeText').textContent = 
                CONFIG.SENSOR_MODE === 'light' ? i18n[currentLanguage].lightSensorMode : i18n[currentLanguage].touchMode;
            
            // æ›´æ–°æ¸¸æˆæ ‡é¢˜
            document.querySelectorAll('.game-title').forEach(title => {
                title.textContent = 'ğŸ® DT Training';
            });
        }

        function t(key) {
            return i18n[currentLanguage] && i18n[currentLanguage][key] ? i18n[currentLanguage][key] : key;
        }

        // ===================================================================
        // æ¸¸æˆé…ç½®å’ŒçŠ¶æ€
        // ===================================================================
        let CONFIG = {
            // äº®åº¦æ£€æµ‹é…ç½®
            BRIGHTNESS_THRESHOLD: 90,
            AVERAGING_WINDOW_SIZE: 10,
            CHECK_INTERVAL: 100,
            DETECTION_ZONE_SIZE_RATIO: 0.5,
            INVERT_SENSOR: false,
            AUTO_FULLSCREEN: false,
            SENSOR_MODE: 'light', // 'light' æˆ– 'touch'
            VIDEO_CONSTRAINTS: {
                video: {
                    facingMode: 'user',
                    focusMode: 'manual'
                }
            },
            // æ¸¸æˆé…ç½®
            SCORE_PER_CYCLE: 1,
            // æ¸¸æˆæ¨¡å¼é»˜è®¤è®¾ç½®
            GAME_SETTINGS: {
                timeAttack: {
                    timeLimit: 60,
                    targetScore: 100,
                    unlimited: false
                },
                endurance: {
                    maxCycles: 10
                }
            }
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            mode: null,
            isPlaying: false,
            isPaused: false,
            score: 0,
            time: 0,
            highScore: getCookie('highScore') || 0,
            lastScoreTime: 0,
            detectionState: 'waiting', // waiting, near, far
            stableTime: 0,
            requiredStableTime: 1000,
            lastDetectionState: null,
            cycleCount: 0,
            currentGameSettings: null,
            isTouching: false
        };

        // æ‘„åƒå¤´ç›¸å…³å˜é‡
        let video, canvas, context;
        let isDetecting = false;
        let brightnessHistory = [];

        // å®šæ—¶å™¨
        let gameTimer = null;
        let detectionTimer = null;

        // éŸ³æ•ˆç³»ç»Ÿ
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.initialized = true;
            }

            playSound(frequency, duration, type = 'sine') {
                if (!this.initialized) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playScore() {
                this.playSound(523, 0.1); // C5
                setTimeout(() => this.playSound(659, 0.1), 100); // E5
                setTimeout(() => this.playSound(784, 0.2), 200); // G5
            }

            playCycle() {
                this.playSound(330, 0.15); // E4
                setTimeout(() => this.playSound(440, 0.15), 150); // A4
            }

            playPause() {
                this.playSound(440, 0.2); // A4
            }

            playResume() {
                this.playSound(523, 0.2); // C5
                setTimeout(() => this.playSound(659, 0.2), 100); // E5
            }

            playCountdown() {
                this.playSound(880, 0.1); // A5
            }

            playGameOver() {
                // åº†ç¥éŸ³æ•ˆï¼šä¸Šå‡çš„éŸ³ç¬¦åºåˆ—
                this.playSound(523, 0.15); // C5
                setTimeout(() => this.playSound(659, 0.15), 150); // E5
                setTimeout(() => this.playSound(784, 0.15), 300); // G5
                setTimeout(() => this.playSound(1047, 0.3), 450); // C6 (é«˜å…«åº¦)
                
                // æ·»åŠ çƒŸèŠ±æ•ˆæœéŸ³
                setTimeout(() => {
                    for(let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            this.playSound(800 + Math.random() * 400, 0.1, 'triangle');
                        }, i * 50);
                    }
                }, 750);
            }

            playPerfect() {
                // å®Œç¾éŸ³æ•ˆï¼šå’Œå¼¦
                this.playSound(523, 0.2); // C5
                this.playSound(659, 0.2); // E5
                this.playSound(784, 0.2); // G5
            }

            playMilestone(count) {
                // é‡Œç¨‹ç¢‘éŸ³æ•ˆ
                const frequencies = [523, 587, 659, 698, 784, 880, 988, 1047];
                const freq = frequencies[Math.min(count - 1, frequencies.length - 1)];
                this.playSound(freq, 0.3);
            }
        }

        const soundSystem = new SoundSystem();

        // ===================================================================
        // DOMå…ƒç´ 
        // ===================================================================
        function initDOM() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
        }

        // ===================================================================
        // æ¸¸æˆæ§åˆ¶å‡½æ•°
        // ===================================================================
        function toggleSensorMode() {
            CONFIG.SENSOR_MODE = CONFIG.SENSOR_MODE === 'light' ? 'touch' : 'light';
            updateSpecialElements();
            
            // ä¿å­˜åˆ°cookie
            setCookie('sensorMode', CONFIG.SENSOR_MODE, 365);
        }

        function showSettings() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            
            // åŠ è½½å½“å‰è®¾ç½®
            document.getElementById('thresholdSlider').value = CONFIG.BRIGHTNESS_THRESHOLD;
            document.getElementById('thresholdValue').textContent = CONFIG.BRIGHTNESS_THRESHOLD;
            document.getElementById('stableTimeSlider').value = CONFIG.requiredStableTime;
            document.getElementById('stableTimeValue').textContent = CONFIG.requiredStableTime;
            document.getElementById('invertSensor').checked = CONFIG.INVERT_SENSOR;
            document.getElementById('autoFullscreen').checked = CONFIG.AUTO_FULLSCREEN;
            document.getElementById('languageSelect').value = currentLanguage;
            
            // åªåœ¨å…‰æ„Ÿæ¨¡å¼ä¸‹æ˜¾ç¤ºä¼ æ„Ÿå™¨ä¿¡æ¯
            const sensorInfo = document.getElementById('sensorInfo');
            if (CONFIG.SENSOR_MODE === 'light') {
                sensorInfo.style.display = 'block';
                startDetectionForSettings();
            } else {
                sensorInfo.style.display = 'none';
            }
        }

        function saveSettings() {
            CONFIG.BRIGHTNESS_THRESHOLD = parseInt(document.getElementById('thresholdSlider').value);
            CONFIG.requiredStableTime = parseInt(document.getElementById('stableTimeSlider').value);
            CONFIG.INVERT_SENSOR = document.getElementById('invertSensor').checked;
            CONFIG.AUTO_FULLSCREEN = document.getElementById('autoFullscreen').checked;
            
            // ä¿å­˜åˆ°cookie
            setCookie('brightnessThreshold', CONFIG.BRIGHTNESS_THRESHOLD, 365);
            setCookie('requiredStableTime', CONFIG.requiredStableTime, 365);
            setCookie('invertSensor', CONFIG.INVERT_SENSOR, 365);
            setCookie('autoFullscreen', CONFIG.AUTO_FULLSCREEN, 365);
            
            backToMenu();
        }

        function showGameSettings(mode) {
            gameState.mode = mode;
            gameState.currentGameSettings = { ...CONFIG.GAME_SETTINGS[mode] };
            
            const modal = document.getElementById('gameSettingsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const modalSettings = document.getElementById('modalSettings');
            
            // æ ¹æ®æ¨¡å¼ç”Ÿæˆè®¾ç½®é¡¹
            let settingsHTML = '';
            
            if (mode === 'timeAttack') {
                modalTitle.textContent = t('timeAttack');
                modalDescription.textContent = t('adjustGameParams');
                settingsHTML = `
                    <div class="modal-setting-item">
                        <label class="modal-setting-label">${t('timeLimit')}</label>
                        <div class="modal-input-group">
                            <input type="number" class="modal-input" id="timeLimit" 
                                   value="${gameState.currentGameSettings.timeLimit}" 
                                   min="5" max="3600" placeholder="${t('range')} 5-3600">
                        </div>
                        <div class="modal-input-hint">${t('secondsToHour')}</div>
                        <div class="preset-buttons">
                            <button class="preset-btn" onclick="setTimeLimit(30)">30${t('sec')}</button>
                            <button class="preset-btn" onclick="setTimeLimit(60)">1${t('min')}</button>
                            <button class="preset-btn" onclick="setTimeLimit(180)">3${t('min')}</button>
                            <button class="preset-btn" onclick="setTimeLimit(300)">5${t('min')}</button>
                            <button class="preset-btn" onclick="setTimeLimit(600)">10${t('min')}</button>
                            <button class="preset-btn" onclick="setTimeLimit(1800)">30${t('min')}</button>
                        </div>
                    </div>
                    <div class="modal-setting-item">
                        <label class="modal-setting-label">${t('targetCount')}</label>
                        <div class="modal-input-group">
                            <input type="number" class="modal-input" id="targetScore" 
                                   value="${gameState.currentGameSettings.targetScore}" 
                                   min="10" max="999999" placeholder="${t('range')} 10-999999">
                        </div>
                        <div class="modal-input-hint">${t('countRange')}</div>
                        <div class="preset-buttons">
                            <button class="preset-btn" onclick="setTargetScore(50)">50${t('count')}</button>
                            <button class="preset-btn" onclick="setTargetScore(100)">100${t('count')}</button>
                            <button class="preset-btn" onclick="setTargetScore(200)">200${t('count')}</button>
                            <button class="preset-btn" onclick="setTargetScore(500)">500${t('count')}</button>
                            <button class="preset-btn" onclick="setTargetScore(1000)">1000${t('count')}</button>
                            <button class="preset-btn" onclick="setTargetScore(5000)">5000${t('count')}</button>
                            <button class="preset-btn unlimited" onclick="setUnlimitedScore()">${t('unlimited')}</button>
                        </div>
                    </div>
                `;
            } else if (mode === 'endurance') {
                modalTitle.textContent = t('endurance');
                modalDescription.textContent = t('adjustGameParams');
                settingsHTML = `
                    <div class="modal-setting-item">
                        <label class="modal-setting-label">${t('maxCycles')}</label>
                        <div class="modal-input-group">
                            <input type="number" class="modal-input" id="maxCycles" 
                                   value="${gameState.currentGameSettings.maxCycles}" 
                                   min="1" max="1000" placeholder="${t('range')} 1-1000">
                        </div>
                        <div class="modal-input-hint">${t('cyclesRange')}</div>
                        <div class="preset-buttons">
                            <button class="preset-btn" onclick="setMaxCycles(5)">5${t('cycles')}</button>
                            <button class="preset-btn" onclick="setMaxCycles(10)">10${t('cycles')}</button>
                            <button class="preset-btn" onclick="setMaxCycles(20)">20${t('cycles')}</button>
                            <button class="preset-btn" onclick="setMaxCycles(50)">50${t('cycles')}</button>
                            <button class="preset-btn" onclick="setMaxCycles(100)">100${t('cycles')}</button>
                            <button class="preset-btn" onclick="setMaxCycles(200)">200${t('cycles')}</button>
                        </div>
                    </div>
                `;
            }
            
            modalSettings.innerHTML = settingsHTML;
            modal.classList.add('show');
        }

        // é¢„è®¾å€¼è®¾ç½®å‡½æ•°
        function setTimeLimit(value) {
            document.getElementById('timeLimit').value = value;
        }

        function setTargetScore(value) {
            document.getElementById('targetScore').value = value;
        }

        function setUnlimitedScore() {
            document.getElementById('targetScore').value = 999999;
        }

        function setMaxCycles(value) {
            document.getElementById('maxCycles').value = value;
        }

        function closeGameSettings() {
            document.getElementById('gameSettingsModal').classList.remove('show');
        }

        function startGameWithSettings() {
            // éªŒè¯è¾“å…¥å€¼
            let isValid = true;
            let errorMessage = '';
            
            if (gameState.mode === 'timeAttack') {
                const timeLimit = parseInt(document.getElementById('timeLimit').value);
                const unlimitedScore = document.getElementById('unlimitedScore') ? 
                    document.getElementById('unlimitedScore').checked : false;
                
                if (isNaN(timeLimit) || timeLimit < 5 || timeLimit > 3600) {
                    isValid = false;
                    errorMessage += t('timeLimitError') + '\n';
                }
                
                if (!unlimitedScore) {
                    const targetScore = parseInt(document.getElementById('targetScore').value);
                    if (isNaN(targetScore) || targetScore < 10 || targetScore > 999999) {
                        isValid = false;
                        errorMessage += t('targetCountError') + '\n';
                    }
                    gameState.currentGameSettings.targetScore = targetScore;
                }
                
                if (isValid) {
                    gameState.currentGameSettings.timeLimit = timeLimit;
                    gameState.currentGameSettings.unlimited = unlimitedScore;
                }
            } else if (gameState.mode === 'endurance') {
                const maxCycles = parseInt(document.getElementById('maxCycles').value);
                
                if (isNaN(maxCycles) || maxCycles < 1 || maxCycles > 1000) {
                    isValid = false;
                    errorMessage += t('maxCyclesError') + '\n';
                }
                
                if (isValid) {
                    gameState.currentGameSettings.maxCycles = maxCycles;
                }
            }
            
            if (!isValid) {
                alert(t('inputError') + ':\n' + errorMessage);
                return;
            }
            
            closeGameSettings();
            startGame(gameState.mode);
        }

        function startGame(mode) {
            // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
            soundSystem.init();
            
            // è‡ªåŠ¨å…¨å±
            if (CONFIG.AUTO_FULLSCREEN) {
                requestFullscreen();
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.score = 0;
            gameState.detectionState = 'waiting';
            gameState.stableTime = 0;
            gameState.cycleCount = 0;
            gameState.isTouching = false;
            
            // æ ¹æ®æ¨¡å¼å’Œè®¾ç½®åˆå§‹åŒ–
            if (mode === 'timeAttack') {
                gameState.time = gameState.currentGameSettings.timeLimit;
            } else if (mode === 'endurance') {
                gameState.time = 0;
            }
            
            // åˆ‡æ¢ç•Œé¢
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('gameArea').style.display = 'flex';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'block';
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            
            // å¯åŠ¨æ£€æµ‹
            if (CONFIG.SENSOR_MODE === 'light') {
                startDetection();
            } else {
                startTouchDetection();
            }
            
            // å¯åŠ¨æ¸¸æˆè®¡æ—¶å™¨
            startGameTimer();
        }

        function pauseGame() {
            if (!gameState.isPlaying) return;
            
            gameState.isPaused = !gameState.isPaused;
            
            if (gameState.isPaused) {
                clearInterval(gameTimer);
                document.querySelector('.control-btn').textContent = t('resume');
                soundSystem.playPause();
            } else {
                startGameTimer();
                document.querySelector('.control-btn').textContent = t('pause');
                soundSystem.playResume();
            }
        }

        function endGame() {
            gameState.isPlaying = false;
            
            // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
            clearInterval(gameTimer);
            stopDetection();
            
            // æ’­æ”¾ç»“æŸéŸ³æ•ˆ
            soundSystem.playGameOver();
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                setCookie('highScore', gameState.highScore, 365);
            }
            
            // é€€å‡ºå…¨å±
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            
            // æ˜¾ç¤ºç»“æŸç•Œé¢
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'none';
            document.getElementById('gameOver').style.display = 'block';
            
            // æ›´æ–°ç»“æŸç•Œé¢ä¿¡æ¯
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('gameModeText').textContent = 
                gameState.mode === 'timeAttack' ? t('timeAttackMode') : t('enduranceMode');
            document.getElementById('cycleCountText').textContent = gameState.cycleCount + ' ' + t('cycles');
            
            // æ ¹æ®æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„æ—¶é—´ä¿¡æ¯
            const timeLabel = document.getElementById('timeLabel');
            const timeUsedText = document.getElementById('timeUsedText');
            
            if (gameState.mode === 'timeAttack') {
                timeLabel.textContent = t('remainingTime') + ':';
                const remainingTime = Math.max(0, gameState.time);
                const minutes = Math.floor(remainingTime / 60);
                const seconds = remainingTime % 60;
                const timeText = minutes > 0 ? `${minutes}${t('min')}${seconds}${t('sec')}` : `${seconds}${t('sec')}`;
                timeUsedText.textContent = timeText;
            } else {
                timeLabel.textContent = t('timeUsed') + ':';
                const minutes = Math.floor(gameState.time / 60);
                const seconds = gameState.time % 60;
                const timeText = minutes > 0 ? `${minutes}${t('minutes')}${seconds}${t('seconds')}` : `${seconds}${t('seconds')}`;
                timeUsedText.textContent = timeText;
            }
            
            document.getElementById('highScore').textContent = t('highestCount') + ': ' + gameState.highScore;
        }

        function restartGame() {
            showGameSettings(gameState.mode);
        }

        function backToMenu() {
            gameState.isPlaying = false;
            clearInterval(gameTimer);
            stopDetection();
            
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'none';
            document.getElementById('gameSettingsModal').classList.remove('show');
            
            // é€€å‡ºå…¨å±
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        // ===================================================================
        // æ¸¸æˆé€»è¾‘
        // ===================================================================
        function startGameTimer() {
            gameTimer = setInterval(() => {
                if (gameState.isPaused) return;
                
                if (gameState.mode === 'timeAttack') {
                    gameState.time--;
                    
                    // æœ€å10ç§’å€’è®¡æ—¶éŸ³æ•ˆ
                    if (gameState.time <= 10 && gameState.time > 0) {
                        soundSystem.playCountdown();
                    }
                    
                    if (gameState.time <= 0) {
                        endGame();
                    }
                    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡æ¬¡æ•°ï¼ˆå¦‚æœä¸æ˜¯æ— ä¸Šé™æ¨¡å¼ï¼‰
                    if (!gameState.currentGameSettings.unlimited && gameState.score >= gameState.currentGameSettings.targetScore) {
                        endGame();
                    }
                } else if (gameState.mode === 'endurance') {
                    gameState.time++;
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆæœ€å¤§å¾ªç¯æ¬¡æ•°
                    if (gameState.cycleCount >= gameState.currentGameSettings.maxCycles) {
                        endGame();
                    }
                }
                
                updateDisplay();
            }, 1000);
        }

        function handleDetection(isNear, brightness) {
            const sensorVisual = document.getElementById('sensorVisual');
            const sensorStatus = document.getElementById('sensorStatus');
            const stateIndicator = document.getElementById('stateIndicator');
            const progressFill = document.getElementById('progressFill');
            
            // æ›´æ–°è®¾ç½®ç•Œé¢çš„å®æ—¶ä¿¡æ¯
            updateSettingsInfo(brightness, isNear);
            
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            if (isNear) {
                sensorVisual.classList.remove('far');
                sensorVisual.classList.add('near');
                
                if (gameState.detectionState !== 'near') {
                    gameState.detectionState = 'near';
                    gameState.stableTime = 0;
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†è¿œç¦»-é è¿‘çš„å¾ªç¯
                    if (gameState.lastDetectionState === 'far') {
                        onCycleComplete(brightness);
                    }
                    
                    stateIndicator.textContent = t('keepNear');
                }
                
                gameState.stableTime += CONFIG.CHECK_INTERVAL;
                const progress = Math.min(gameState.stableTime / CONFIG.requiredStableTime, 1);
                progressFill.style.width = `${progress * 100}%`;
                sensorStatus.textContent = t('detecting');
                
            } else {
                sensorVisual.classList.remove('near');
                sensorVisual.classList.add('far');
                
                if (gameState.detectionState !== 'far') {
                    gameState.detectionState = 'far';
                    gameState.stableTime = 0;
                    progressFill.style.width = '0%';
                    stateIndicator.textContent = t('pleaseFar');
                }
                
                gameState.lastDetectionState = 'far';
                sensorStatus.textContent = t('waitForNear');
            }
        }

        function onCycleComplete(brightness) {
            // æ¯æ¬¡å¾—åˆ†å›ºå®šä¸º1åˆ†
            gameState.score += CONFIG.SCORE_PER_CYCLE;
            gameState.cycleCount++;
            
            // é‡Œç¨‹ç¢‘éŸ³æ•ˆ
            if (gameState.cycleCount % 10 === 0) {
                soundSystem.playMilestone(gameState.cycleCount / 10);
            } else if (gameState.cycleCount % 5 === 0) {
                soundSystem.playPerfect();
            } else {
                soundSystem.playScore();
            }
            
            // è§†è§‰åé¦ˆ
            showComboIndicator('+1');
            
            const sensorVisual = document.getElementById('sensorVisual');
            sensorVisual.classList.add('scoring');
            setTimeout(() => sensorVisual.classList.remove('scoring'), 300);
            
            // æ›´æ–°çŠ¶æ€
            gameState.lastDetectionState = 'near';
            
            // æ£€æŸ¥è€åŠ›æ¨¡å¼æ˜¯å¦å®Œæˆ
            if (gameState.mode === 'endurance' && gameState.cycleCount >= gameState.currentGameSettings.maxCycles) {
                setTimeout(() => endGame(), 500); // å»¶è¿Ÿä¸€ä¸‹è®©åŠ¨ç”»å®Œæˆ
            }
            
            updateDisplay();
        }

        function showComboIndicator(text) {
            const indicator = document.getElementById('comboIndicator');
            indicator.textContent = text;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        }

        function updateDisplay() {
            document.getElementById('gameScore').textContent = gameState.score;
            document.getElementById('timer').textContent = gameState.time;
        }

        function updateSettingsInfo(brightness, isNear) {
            if (document.getElementById('settingsPanel').style.display === 'block') {
                document.getElementById('currentBrightness').textContent = brightness ? brightness.toFixed(1) : '-';
                document.getElementById('smoothedBrightness').textContent = brightness ? brightness.toFixed(1) : '-';
                document.getElementById('detectionStatus').textContent = isNear ? t('detectedNear') : t('notDetected');
                
                // æ›´æ–°äº®åº¦æ¡
                const brightnessPercent = Math.min((brightness / 255) * 100, 100);
                document.getElementById('brightnessFill').style.width = `${brightnessPercent}%`;
            }
        }

        // ===================================================================
        // è§¦ç¢°æ£€æµ‹åŠŸèƒ½
        // ===================================================================
        function startTouchDetection() {
            const touchOverlay = document.getElementById('touchOverlay');
            touchOverlay.classList.add('active');
            
            // è§¦æ‘¸å¼€å§‹
            touchOverlay.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.isTouching = true;
                handleDetection(true, 0);
            });
            
            // è§¦æ‘¸ç»“æŸ
            touchOverlay.addEventListener('touchend', (e) => {
                e.preventDefault();
                gameState.isTouching = false;
                handleDetection(false, 0);
            });
            
            // é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæ¡Œé¢æµ‹è¯•ï¼‰
            touchOverlay.addEventListener('mousedown', (e) => {
                e.preventDefault();
                gameState.isTouching = true;
                handleDetection(true, 0);
            });
            
            touchOverlay.addEventListener('mouseup', (e) => {
                e.preventDefault();
                gameState.isTouching = false;
                handleDetection(false, 0);
            });
        }

        function stopTouchDetection() {
            const touchOverlay = document.getElementById('touchOverlay');
            touchOverlay.classList.remove('active');
            gameState.isTouching = false;
        }

        // ===================================================================
        // æ‘„åƒå¤´æ£€æµ‹åŠŸèƒ½
        // ===================================================================
        async function startDetection() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(CONFIG.VIDEO_CONSTRAINTS);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    isDetecting = true;
                    detectBrightness();
                };
            } catch (err) {
                console.error("Unable to access camera: ", err);
                alert(t('cameraError'));
                backToMenu();
            }
        }

        async function startDetectionForSettings() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(CONFIG.VIDEO_CONSTRAINTS);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    isDetecting = true;
                    detectBrightness();
                };
            } catch (err) {
                console.error("Unable to access camera: ", err);
                document.getElementById('detectionStatus').textContent = t('cameraAccessFailed');
            }
        }

        function stopDetection() {
            isDetecting = false;
            if (detectionTimer) {
                clearTimeout(detectionTimer);
            }
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            brightnessHistory = [];
            stopTouchDetection();
        }

        function detectBrightness() {
            if (!isDetecting) return;
            
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const zoneWidth = canvas.width * CONFIG.DETECTION_ZONE_SIZE_RATIO;
            const zoneHeight = canvas.height * CONFIG.DETECTION_ZONE_SIZE_RATIO;
            const startX = (canvas.width - zoneWidth) / 2;
            const startY = (canvas.height - zoneHeight) / 2;
            
            const imageData = context.getImageData(startX, startY, zoneWidth, zoneHeight);
            const data = imageData.data;
            
            let totalBrightness = 0;
            const pixelCount = data.length / 4;
            
            for (let i = 0; i < pixelCount; i++) {
                const r = data[i * 4];
                const g = data[i * 4 + 1];
                const b = data[i * 4 + 2];
                const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
                totalBrightness += brightness;
            }
            
            const currentBrightness = totalBrightness / pixelCount;
            
            brightnessHistory.push(currentBrightness);
            if (brightnessHistory.length > CONFIG.AVERAGING_WINDOW_SIZE) {
                brightnessHistory.shift();
            }
            
            let smoothedBrightness = 0;
            for (const value of brightnessHistory) {
                smoothedBrightness += value;
            }
            smoothedBrightness /= brightnessHistory.length;
            
            // æ ¹æ®åè½¬è®¾ç½®åˆ¤æ–­æ˜¯å¦é è¿‘
            let isNear;
            if (CONFIG.INVERT_SENSOR) {
                // åè½¬æ¨¡å¼ï¼šäº®åº¦é«˜è¡¨ç¤ºé è¿‘
                isNear = smoothedBrightness > CONFIG.BRIGHTNESS_THRESHOLD && brightnessHistory.length >= CONFIG.AVERAGING_WINDOW_SIZE;
            } else {
                // æ­£å¸¸æ¨¡å¼ï¼šäº®åº¦ä½è¡¨ç¤ºé è¿‘
                isNear = smoothedBrightness < CONFIG.BRIGHTNESS_THRESHOLD && brightnessHistory.length >= CONFIG.AVERAGING_WINDOW_SIZE;
            }
            
            handleDetection(isNear, smoothedBrightness);
            
            detectionTimer = setTimeout(detectBrightness, CONFIG.CHECK_INTERVAL);
        }

        // ===================================================================
        // å…¨å±åŠŸèƒ½
        // ===================================================================
        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        // ===================================================================
        // åˆå§‹åŒ–
        // ===================================================================
        function init() {
            initDOM();
            createParticles();
            loadSettings();
            updateDisplay();
            
            // è®¾ç½®æ»‘å—äº‹ä»¶
            document.getElementById('thresholdSlider').addEventListener('input', function() {
                document.getElementById('thresholdValue').textContent = this.value;
            });
            
            document.getElementById('stableTimeSlider').addEventListener('input', function() {
                document.getElementById('stableTimeValue').textContent = this.value;
            });
        }

        function loadSettings() {
            const savedThreshold = getCookie('brightnessThreshold');
            const savedStableTime = getCookie('requiredStableTime');
            const savedInvertSensor = getCookie('invertSensor');
            const savedAutoFullscreen = getCookie('autoFullscreen');
            const savedSensorMode = getCookie('sensorMode');
            const savedLanguage = getCookie('language');
            
            if (savedThreshold) {
                CONFIG.BRIGHTNESS_THRESHOLD = parseInt(savedThreshold);
            }
            if (savedStableTime) {
                CONFIG.requiredStableTime = parseInt(savedStableTime);
            }
            if (savedInvertSensor !== null) {
                CONFIG.INVERT_SENSOR = savedInvertSensor === 'true';
            }
            if (savedAutoFullscreen !== null) {
                CONFIG.AUTO_FULLSCREEN = savedAutoFullscreen === 'true';
            }
            if (savedSensorMode) {
                CONFIG.SENSOR_MODE = savedSensorMode;
            }
            if (savedLanguage) {
                currentLanguage = savedLanguage;
            }
            
            updateLanguage();
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 4 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                particlesContainer.appendChild(particle);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>

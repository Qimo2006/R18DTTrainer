<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é è¿‘æŒ‘æˆ˜ - äº’åŠ¨æ„Ÿåº”æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow-x: hidden;
            user-select: none;
        }

        /* éšè—çš„æ‘„åƒå¤´å…ƒç´  */
        #video, #canvas {
            display: none;
        }

        /* å¤´éƒ¨ä¿¡æ¯æ  */
        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none; /* æ¸¸æˆå¼€å§‹å‰éšè— */
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* ä¸»æ¸¸æˆåŒºåŸŸ */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        /* æ¸¸æˆæ¨¡å¼é€‰æ‹©ç•Œé¢ */
        .mode-selection {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        .mode-selection .game-title {
            text-align: center;
            font-size: 42px;
            margin-bottom: 40px;
            display: block;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        /* æ¸¸æˆæ¨¡å¼æŒ‰é’® - æ¸å˜è“è‰² */
        .mode-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            border: none;
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .mode-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .mode-btn:hover:before {
            left: 100%;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-description {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* åˆ‡æ¢æ¨¡å¼æŒ‰é’® - æ¸å˜ç»¿è‰² */
        .toggle-btn {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            border: none;
            color: white;
            padding: 18px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
            width: 100%;
        }

        .toggle-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* è®¾ç½®æŒ‰é’® - æ¸å˜ç´«è‰² */
        .settings-btn {
            background: linear-gradient(135deg, #ee0979, #ff6a00);
            border: none;
            color: white;
            padding: 18px;
            border-radius: 15px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            width: 100%;
        }

        .settings-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* è®¾ç½®ç•Œé¢ */
        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
            display: none;
        }

        .settings-panel h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .setting-item {
            margin-bottom: 25px;
        }

        .setting-label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            opacity: 0.9;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            transition: opacity 0.2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox {
            width: 20px;
            height: 20px;
            accent-color: #ffd700;
        }

        .sensor-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .sensor-info h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #ffd700;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .info-label {
            opacity: 0.8;
        }

        .info-value {
            font-weight: bold;
            color: #4caf50;
        }

        .brightness-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .brightness-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
        }

        /* æ¸¸æˆè®¾ç½®å¼¹çª— */
        .game-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .game-settings-modal.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
            max-height: 80vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .modal-header h2 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .modal-header p {
            opacity: 0.8;
            font-size: 14px;
        }

        .modal-settings {
            margin-bottom: 30px;
        }

        .modal-setting-item {
            margin-bottom: 20px;
        }

        .modal-setting-label {
            display: block;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .modal-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-input {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .modal-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .modal-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.3);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .modal-input-hint {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .preset-btn {
            padding: 6px 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .preset-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        .modal-btn.secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-area {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            animation: fadeIn 0.5s ease-out;
            width: 100%;
            height: 100vh;
            justify-content: center;
        }

        /* æ¸¸æˆä¸­çš„åˆ†æ•°æ˜¾ç¤º */
        .game-score {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 120px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            z-index: 10;
            animation: scoreGlow 2s ease-in-out infinite alternate;
        }

        @keyframes scoreGlow {
            from {
                text-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
            }
            to {
                text-shadow: 0 0 50px rgba(255, 215, 0, 1);
            }
        }

        .sensor-visual {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .sensor-visual.near {
            border-color: #4caf50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
            animation: pulse 1s infinite;
        }

        .sensor-visual.far {
            border-color: #2196f3;
            box-shadow: 0 0 30px rgba(33, 150, 243, 0.6);
        }

        .sensor-visual.scoring {
            border-color: #ffd700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .sensor-status {
            font-size: 18px;
            text-align: center;
        }

        .state-indicator {
            margin-top: 10px;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            font-size: 14px;
        }

        .progress-bar {
            width: 300px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .combo-indicator {
            position: absolute;
            top: 30%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            opacity: 0;
            pointer-events: none;
            z-index: 20;
        }

        .combo-indicator.show {
            animation: comboPopup 1s ease-out;
        }

        @keyframes comboPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            position: absolute;
            bottom: 30px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border: none;
        }

        /* æ¸¸æˆç»“æŸç•Œé¢ */
        .game-over {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .game-over h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .final-score {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .high-score {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç²’å­æ•ˆæœ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .mode-selection .game-title {
                font-size: 32px;
            }

            .mode-selection, .settings-panel {
                padding: 30px 20px;
            }

            .sensor-visual {
                width: 150px;
                height: 150px;
            }

            .progress-bar {
                width: 250px;
            }

            .game-score {
                font-size: 80px;
            }

            .modal-content {
                padding: 30px 20px;
            }
        }

        /* è§¦ç¢°æ¨¡å¼è¦†ç›–å±‚ */
        .touch-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 5;
            display: none;
        }

        .touch-overlay.active {
            display: block;
        }
    </style>
</head>
<body>
    <!-- éšè—çš„æ‘„åƒå¤´å…ƒç´  -->
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <!-- è§¦ç¢°æ¨¡å¼è¦†ç›–å±‚ -->
    <div class="touch-overlay" id="touchOverlay"></div>

    <!-- ç²’å­èƒŒæ™¯ -->
    <div class="particles" id="particles"></div>

    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <header id="gameHeader">
        <div class="header-content">
            <h1 class="game-title">ğŸ® é è¿‘æŒ‘æˆ˜</h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">æ—¶é—´</span>
                    <span class="stat-value" id="timer">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">è¿å‡»</span>
                    <span class="stat-value" id="combo">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
    <main>
        <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹© -->
        <section class="mode-selection" id="modeSelection">
            <h1 class="game-title">ğŸ® é è¿‘æŒ‘æˆ˜</h1>
            <div class="mode-buttons">
                <button class="mode-btn" onclick="showGameSettings('timeAttack')">
                    â±ï¸ é™æ—¶æŒ‘æˆ˜
                    <div class="mode-description">åœ¨é™å®šæ—¶é—´å†…è·å¾—å°½å¯èƒ½é«˜çš„åˆ†æ•°</div>
                </button>
                <button class="mode-btn" onclick="showGameSettings('endurance')">
                    ğŸ’ª è€åŠ›æ¨¡å¼
                    <div class="mode-description">ä¿æŒé è¿‘-è¿œç¦»å¾ªç¯ï¼Œå®ŒæˆæŒ‡å®šæ¬¡æ•°</div>
                </button>
            </div>
            <button class="toggle-btn" onclick="toggleSensorMode()">
                ğŸ”„ å½“å‰æ¨¡å¼: <span id="currentModeText">å…‰æ„Ÿæ¨¡å¼</span>
            </button>
            <button class="settings-btn" onclick="showSettings()">
                âš™ï¸ æ¸¸æˆè®¾ç½®
            </button>
        </section>

        <!-- è®¾ç½®ç•Œé¢ -->
        <section class="settings-panel" id="settingsPanel">
            <h2>âš™ï¸ æ¸¸æˆè®¾ç½®</h2>
            
            <div class="setting-item">
                <label class="setting-label">é è¿‘é˜ˆå€¼ (äº®åº¦å€¼è¶Šä½è¶Šæ•æ„Ÿ)</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="thresholdSlider" min="30" max="150" value="90">
                    <span class="slider-value" id="thresholdValue">90</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">ç¨³å®šæ—¶é—´ (æ¯«ç§’)</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="stableTimeSlider" min="300" max="2000" value="1000" step="100">
                    <span class="slider-value" id="stableTimeValue">1000</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">åè½¬æ„Ÿå…‰ (æ‰‹æœºç«¯æ¨è)</label>
                <div class="checkbox-container">
                    <input type="checkbox" class="checkbox" id="invertSensor">
                    <span>å¼€å¯åï¼Œé è¿‘æ—¶å…‰å¼ºé«˜ï¼Œè¿œç¦»æ—¶å…‰å¼ºä½</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">å¼€å§‹æ¸¸æˆè‡ªåŠ¨å…¨å±</label>
                <div class="checkbox-container">
                    <input type="checkbox" class="checkbox" id="autoFullscreen">
                    <span>æ¸¸æˆå¼€å§‹æ—¶è‡ªåŠ¨è¿›å…¥å…¨å±æ¨¡å¼</span>
                </div>
            </div>

            <div class="sensor-info" id="sensorInfo">
                <h3>ğŸ“Š å®æ—¶æ„Ÿå…‰ä¿¡æ¯</h3>
                <div class="info-row">
                    <span class="info-label">å½“å‰äº®åº¦:</span>
                    <span class="info-value" id="currentBrightness">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¹³æ»‘äº®åº¦:</span>
                    <span class="info-value" id="smoothedBrightness">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ£€æµ‹çŠ¶æ€:</span>
                    <span class="info-value" id="detectionStatus">æœªå¼€å§‹</span>
                </div>
                <div class="brightness-bar">
                    <div class="brightness-fill" id="brightnessFill"></div>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                <button class="control-btn" onclick="backToMenu()">è¿”å›èœå•</button>
            </div>
        </section>

        <!-- æ¸¸æˆè®¾ç½®å¼¹çª— -->
        <div class="game-settings-modal" id="gameSettingsModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">æ¸¸æˆè®¾ç½®</h2>
                    <p id="modalDescription">è°ƒæ•´æ¸¸æˆå‚æ•°</p>
                </div>
                <div class="modal-settings" id="modalSettings">
                    <!-- åŠ¨æ€ç”Ÿæˆè®¾ç½®é¡¹ -->
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeGameSettings()">å–æ¶ˆ</button>
                    <button class="modal-btn primary" onclick="startGameWithSettings()">å¼€å§‹æ¸¸æˆ</button>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <section class="game-area" id="gameArea">
            <div class="game-score" id="gameScore">0</div>
            <div class="sensor-visual" id="sensorVisual">
                <div>
                    <div class="sensor-status" id="sensorStatus">å‡†å¤‡å°±ç»ª</div>
                    <div class="state-indicator" id="stateIndicator">ç­‰å¾…é è¿‘</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="combo-indicator" id="comboIndicator"></div>

            <div class="controls">
                <button class="control-btn" onclick="pauseGame()">æš‚åœ</button>
                <button class="control-btn primary" onclick="backToMenu()">è¿”å›èœå•</button>
            </div>
        </section>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <section class="game-over" id="gameOver">
            <h2>æ¸¸æˆç»“æŸï¼</h2>
            <div class="final-score" id="finalScore">0</div>
            <div class="high-score" id="highScore">æœ€é«˜åˆ†: 0</div>
            <div class="controls">
                <button class="control-btn primary" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
                <button class="control-btn" onclick="backToMenu()">è¿”å›èœå•</button>
            </div>
        </section>
    </main>

    <script>
        // ===================================================================
        // Cookie å·¥å…·å‡½æ•°
        // ===================================================================
        function setCookie(name, value, days) {
            const expires = new Date();
            expires.setTime(expires.getTime() + (days * 24 * 60 * 60 * 1000));
            document.cookie = `${name}=${value};expires=${expires.toUTCString()};path=/`;
        }

        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }

        function deleteCookie(name) {
            document.cookie = `${name}=;expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/`;
        }

        // ===================================================================
        // æ¸¸æˆé…ç½®å’ŒçŠ¶æ€
        // ===================================================================
        let CONFIG = {
            // äº®åº¦æ£€æµ‹é…ç½®
            BRIGHTNESS_THRESHOLD: 90,
            AVERAGING_WINDOW_SIZE: 10,
            CHECK_INTERVAL: 100,
            DETECTION_ZONE_SIZE_RATIO: 0.5,
            INVERT_SENSOR: false,
            AUTO_FULLSCREEN: false,
            SENSOR_MODE: 'light', // 'light' æˆ– 'touch'
            VIDEO_CONSTRAINTS: {
                video: {
                    facingMode: 'user',
                    focusMode: 'manual'
                }
            },
            // æ¸¸æˆé…ç½®
            SCORE_MULTIPLIER: 10,
            COMBO_TIMEOUT: 2000,
            // æ¸¸æˆæ¨¡å¼é»˜è®¤è®¾ç½®
            GAME_SETTINGS: {
                timeAttack: {
                    timeLimit: 60,
                    targetScore: 100
                },
                endurance: {
                    maxCycles: 10
                }
            }
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            mode: null,
            isPlaying: false,
            isPaused: false,
            score: 0,
            combo: 0,
            time: 0,
            highScore: getCookie('highScore') || 0,
            lastScoreTime: 0,
            detectionState: 'waiting', // waiting, near, far
            stableTime: 0,
            requiredStableTime: 1000,
            lastDetectionState: null,
            cycleCount: 0,
            currentGameSettings: null,
            isTouching: false
        };

        // æ‘„åƒå¤´ç›¸å…³å˜é‡
        let video, canvas, context;
        let isDetecting = false;
        let brightnessHistory = [];

        // å®šæ—¶å™¨
        let gameTimer = null;
        let detectionTimer = null;

        // éŸ³æ•ˆç³»ç»Ÿ
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.initialized = true;
            }

            playSound(frequency, duration, type = 'sine') {
                if (!this.initialized) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playScore() {
                this.playSound(523, 0.1); // C5
                setTimeout(() => this.playSound(659, 0.1), 100); // E5
                setTimeout(() => this.playSound(784, 0.2), 200); // G5
            }

            playCombo() {
                this.playSound(440, 0.1); // A4
                setTimeout(() => this.playSound(554, 0.1), 50); // C#5
                setTimeout(() => this.playSound(659, 0.1), 100); // E5
            }

            playCycle() {
                this.playSound(330, 0.15); // E4
                setTimeout(() => this.playSound(440, 0.15), 150); // A4
            }

            playGameOver() {
                this.playSound(220, 0.3, 'sawtooth'); // A3
                setTimeout(() => this.playSound(196, 0.3, 'sawtooth'), 200); // G3
                setTimeout(() => this.playSound(175, 0.4, 'sawtooth'), 400); // F3
            }
        }

        const soundSystem = new SoundSystem();

        // ===================================================================
        // DOMå…ƒç´ 
        // ===================================================================
        function initDOM() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
        }

        // ===================================================================
        // æ¸¸æˆæ§åˆ¶å‡½æ•°
        // ===================================================================
        function toggleSensorMode() {
            CONFIG.SENSOR_MODE = CONFIG.SENSOR_MODE === 'light' ? 'touch' : 'light';
            document.getElementById('currentModeText').textContent = 
                CONFIG.SENSOR_MODE === 'light' ? 'å…‰æ„Ÿæ¨¡å¼' : 'è§¦ç¢°æ¨¡å¼';
            
            // ä¿å­˜åˆ°cookie
            setCookie('sensorMode', CONFIG.SENSOR_MODE, 365);
        }

        function showSettings() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            
            // åŠ è½½å½“å‰è®¾ç½®
            document.getElementById('thresholdSlider').value = CONFIG.BRIGHTNESS_THRESHOLD;
            document.getElementById('thresholdValue').textContent = CONFIG.BRIGHTNESS_THRESHOLD;
            document.getElementById('stableTimeSlider').value = CONFIG.requiredStableTime;
            document.getElementById('stableTimeValue').textContent = CONFIG.requiredStableTime;
            document.getElementById('invertSensor').checked = CONFIG.INVERT_SENSOR;
            document.getElementById('autoFullscreen').checked = CONFIG.AUTO_FULLSCREEN;
            
            // åªåœ¨å…‰æ„Ÿæ¨¡å¼ä¸‹æ˜¾ç¤ºä¼ æ„Ÿå™¨ä¿¡æ¯
            const sensorInfo = document.getElementById('sensorInfo');
            if (CONFIG.SENSOR_MODE === 'light') {
                sensorInfo.style.display = 'block';
                startDetectionForSettings();
            } else {
                sensorInfo.style.display = 'none';
            }
        }

        function saveSettings() {
            CONFIG.BRIGHTNESS_THRESHOLD = parseInt(document.getElementById('thresholdSlider').value);
            CONFIG.requiredStableTime = parseInt(document.getElementById('stableTimeSlider').value);
            CONFIG.INVERT_SENSOR = document.getElementById('invertSensor').checked;
            CONFIG.AUTO_FULLSCREEN = document.getElementById('autoFullscreen').checked;
            
            // ä¿å­˜åˆ°cookie
            setCookie('brightnessThreshold', CONFIG.BRIGHTNESS_THRESHOLD, 365);
            setCookie('requiredStableTime', CONFIG.requiredStableTime, 365);
            setCookie('invertSensor', CONFIG.INVERT_SENSOR, 365);
            setCookie('autoFullscreen', CONFIG.AUTO_FULLSCREEN, 365);
            
            backToMenu();
        }

        function showGameSettings(mode) {
            gameState.mode = mode;
            gameState.currentGameSettings = { ...CONFIG.GAME_SETTINGS[mode] };
            
            const modal = document.getElementById('gameSettingsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalDescription = document.getElementById('modalDescription');
            const modalSettings = document.getElementById('modalSettings');
            
            // æ ¹æ®æ¨¡å¼ç”Ÿæˆè®¾ç½®é¡¹
            let settingsHTML = '';
            
            if (mode === 'timeAttack') {
                modalTitle.textContent = 'â±ï¸ é™æ—¶æŒ‘æˆ˜è®¾ç½®';
                modalDescription.textContent = 'è®¾ç½®é™æ—¶æŒ‘æˆ˜çš„å‚æ•°';
                settingsHTML = `
                    <div class="modal-setting-item">
                        <label class="modal-setting-label">é™æ—¶æ—¶é—´ (ç§’)</label>
                        <div class="modal-input-group">
                            <input type="number" class="modal-input" id="timeLimit" 
                                   value="${gameState.currentGameSettings.timeLimit}" 
                                   min="5" max="3600" placeholder="è¾“å…¥5-3600ä¹‹é—´çš„æ•°å­—">
                        </div>
                        <div class="modal-input-hint">èŒƒå›´ï¼š5ç§’ - 1å°æ—¶</div>
                        <div class="preset-buttons">
                            <button class="preset-btn" onclick="setTimeLimit(30)">30ç§’</button>
                            <button class="preset-btn" onclick="setTimeLimit(60)">1åˆ†é’Ÿ</button>
                            <button class="preset-btn" onclick="setTimeLimit(180)">3åˆ†é’Ÿ</button>
                            <button class="preset-btn" onclick="setTimeLimit(300)">5åˆ†é’Ÿ</button>
                            <button class="preset-btn" onclick="setTimeLimit(600)">10åˆ†é’Ÿ</button>
                            <button class="preset-btn" onclick="setTimeLimit(1800)">30åˆ†é’Ÿ</button>
                        </div>
                    </div>
                    <div class="modal-setting-item">
                        <label class="modal-setting-label">ç›®æ ‡åˆ†æ•°</label>
                        <div class="modal-input-group">
                            <input type="number" class="modal-input" id="targetScore" 
                                   value="${gameState.currentGameSettings.targetScore}" 
                                   min="10" max="99999" placeholder="è¾“å…¥10-99999ä¹‹é—´çš„æ•°å­—">
                        </div>
                        <div class="modal-input-hint">èŒƒå›´ï¼š10åˆ† - 99999åˆ†</div>
                        <div class="preset-buttons">
                            <button class="preset-btn" onclick="setTargetScore(50)">50åˆ†</button>
                            <button class="preset-btn" onclick="setTargetScore(100)">100åˆ†</button>
                            <button class="preset-btn" onclick="setTargetScore(200)">200åˆ†</button>
                            <button class="preset-btn" onclick="setTargetScore(500)">500åˆ†</button>
                            <button class="preset-btn" onclick="setTargetScore(1000)">1000åˆ†</button>
                            <button class="preset-btn" onclick="setTargetScore(5000)">5000åˆ†</button>
                        </div>
                    </div>
                `;
            } else if (mode === 'endurance') {
                modalTitle.textContent = 'ğŸ’ª è€åŠ›æ¨¡å¼è®¾ç½®';
                modalDescription.textContent = 'è®¾ç½®è€åŠ›æ¨¡å¼çš„å‚æ•°';
                settingsHTML = `
                    <div class="modal-setting-item">
                        <label class="modal-setting-label">æœ€å¤§å¾ªç¯æ¬¡æ•°</label>
                        <div class="modal-input-group">
                            <input type="number" class="modal-input" id="maxCycles" 
                                   value="${gameState.currentGameSettings.maxCycles}" 
                                   min="1" max="1000" placeholder="è¾“å…¥1-1000ä¹‹é—´çš„æ•°å­—">
                        </div>
                        <div class="modal-input-hint">èŒƒå›´ï¼š1æ¬¡ - 1000æ¬¡</div>
                        <div class="preset-buttons">
                            <button class="preset-btn" onclick="setMaxCycles(5)">5æ¬¡</button>
                            <button class="preset-btn" onclick="setMaxCycles(10)">10æ¬¡</button>
                            <button class="preset-btn" onclick="setMaxCycles(20)">20æ¬¡</button>
                            <button class="preset-btn" onclick="setMaxCycles(50)">50æ¬¡</button>
                            <button class="preset-btn" onclick="setMaxCycles(100)">100æ¬¡</button>
                            <button class="preset-btn" onclick="setMaxCycles(200)">200æ¬¡</button>
                        </div>
                    </div>
                `;
            }
            
            modalSettings.innerHTML = settingsHTML;
            modal.classList.add('show');
        }

        // é¢„è®¾å€¼è®¾ç½®å‡½æ•°
        function setTimeLimit(value) {
            document.getElementById('timeLimit').value = value;
        }

        function setTargetScore(value) {
            document.getElementById('targetScore').value = value;
        }

        function setMaxCycles(value) {
            document.getElementById('maxCycles').value = value;
        }

        function closeGameSettings() {
            document.getElementById('gameSettingsModal').classList.remove('show');
        }

        function startGameWithSettings() {
            // éªŒè¯è¾“å…¥å€¼
            let isValid = true;
            let errorMessage = '';
            
            if (gameState.mode === 'timeAttack') {
                const timeLimit = parseInt(document.getElementById('timeLimit').value);
                const targetScore = parseInt(document.getElementById('targetScore').value);
                
                if (isNaN(timeLimit) || timeLimit < 5 || timeLimit > 3600) {
                    isValid = false;
                    errorMessage += 'é™æ—¶æ—¶é—´å¿…é¡»åœ¨5-3600ç§’ä¹‹é—´\n';
                }
                
                if (isNaN(targetScore) || targetScore < 10 || targetScore > 99999) {
                    isValid = false;
                    errorMessage += 'ç›®æ ‡åˆ†æ•°å¿…é¡»åœ¨10-99999åˆ†ä¹‹é—´\n';
                }
                
                if (isValid) {
                    gameState.currentGameSettings.timeLimit = timeLimit;
                    gameState.currentGameSettings.targetScore = targetScore;
                }
            } else if (gameState.mode === 'endurance') {
                const maxCycles = parseInt(document.getElementById('maxCycles').value);
                
                if (isNaN(maxCycles) || maxCycles < 1 || maxCycles > 1000) {
                    isValid = false;
                    errorMessage += 'å¾ªç¯æ¬¡æ•°å¿…é¡»åœ¨1-1000æ¬¡ä¹‹é—´\n';
                }
                
                if (isValid) {
                    gameState.currentGameSettings.maxCycles = maxCycles;
                }
            }
            
            if (!isValid) {
                alert('è¾“å…¥é”™è¯¯ï¼š\n' + errorMessage);
                return;
            }
            
            closeGameSettings();
            startGame(gameState.mode);
        }

        function startGame(mode) {
            // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
            soundSystem.init();
            
            // è‡ªåŠ¨å…¨å±
            if (CONFIG.AUTO_FULLSCREEN) {
                requestFullscreen();
            }
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.score = 0;
            gameState.combo = 0;
            gameState.detectionState = 'waiting';
            gameState.stableTime = 0;
            gameState.cycleCount = 0;
            gameState.isTouching = false;
            
            // æ ¹æ®æ¨¡å¼å’Œè®¾ç½®åˆå§‹åŒ–
            if (mode === 'timeAttack') {
                gameState.time = gameState.currentGameSettings.timeLimit;
            } else if (mode === 'endurance') {
                gameState.time = 0;
            }
            
            // åˆ‡æ¢ç•Œé¢
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('gameArea').style.display = 'flex';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'block';
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            
            // å¯åŠ¨æ£€æµ‹
            if (CONFIG.SENSOR_MODE === 'light') {
                startDetection();
            } else {
                startTouchDetection();
            }
            
            // å¯åŠ¨æ¸¸æˆè®¡æ—¶å™¨
            startGameTimer();
        }

        function pauseGame() {
            if (!gameState.isPlaying) return;
            
            gameState.isPaused = !gameState.isPaused;
            
            if (gameState.isPaused) {
                clearInterval(gameTimer);
                document.querySelector('.control-btn').textContent = 'ç»§ç»­';
            } else {
                startGameTimer();
                document.querySelector('.control-btn').textContent = 'æš‚åœ';
            }
        }

        function endGame() {
            gameState.isPlaying = false;
            
            // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
            clearInterval(gameTimer);
            stopDetection();
            
            // æ’­æ”¾ç»“æŸéŸ³æ•ˆ
            soundSystem.playGameOver();
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                setCookie('highScore', gameState.highScore, 365);
            }
            
            // é€€å‡ºå…¨å±
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            
            // æ˜¾ç¤ºç»“æŸç•Œé¢
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'none';
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('highScore').textContent = `æœ€é«˜åˆ†: ${gameState.highScore}`;
        }

        function restartGame() {
            showGameSettings(gameState.mode);
        }

        function backToMenu() {
            gameState.isPlaying = false;
            clearInterval(gameTimer);
            stopDetection();
            
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            document.getElementById('gameHeader').style.display = 'none';
            document.getElementById('gameSettingsModal').classList.remove('show');
            
            // é€€å‡ºå…¨å±
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
        }

        // ===================================================================
        // æ¸¸æˆé€»è¾‘
        // ===================================================================
        function startGameTimer() {
            gameTimer = setInterval(() => {
                if (gameState.isPaused) return;
                
                if (gameState.mode === 'timeAttack') {
                    gameState.time--;
                    if (gameState.time <= 0) {
                        endGame();
                    }
                    // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°ç›®æ ‡åˆ†æ•°
                    if (gameState.score >= gameState.currentGameSettings.targetScore) {
                        endGame();
                    }
                } else if (gameState.mode === 'endurance') {
                    gameState.time++;
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆæœ€å¤§å¾ªç¯æ¬¡æ•°
                    if (gameState.cycleCount >= gameState.currentGameSettings.maxCycles) {
                        endGame();
                    }
                }
                
                updateDisplay();
            }, 1000);
        }

        function handleDetection(isNear, brightness) {
            const sensorVisual = document.getElementById('sensorVisual');
            const sensorStatus = document.getElementById('sensorStatus');
            const stateIndicator = document.getElementById('stateIndicator');
            const progressFill = document.getElementById('progressFill');
            
            // æ›´æ–°è®¾ç½®ç•Œé¢çš„å®æ—¶ä¿¡æ¯
            updateSettingsInfo(brightness, isNear);
            
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            if (isNear) {
                sensorVisual.classList.remove('far');
                sensorVisual.classList.add('near');
                
                if (gameState.detectionState !== 'near') {
                    gameState.detectionState = 'near';
                    gameState.stableTime = 0;
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†è¿œç¦»-é è¿‘çš„å¾ªç¯
                    if (gameState.lastDetectionState === 'far') {
                        onCycleComplete(brightness);
                    }
                    
                    stateIndicator.textContent = 'ä¿æŒé è¿‘';
                }
                
                gameState.stableTime += CONFIG.CHECK_INTERVAL;
                const progress = Math.min(gameState.stableTime / CONFIG.requiredStableTime, 1);
                progressFill.style.width = `${progress * 100}%`;
                sensorStatus.textContent = 'æ£€æµ‹ä¸­...';
                
            } else {
                sensorVisual.classList.remove('near');
                sensorVisual.classList.add('far');
                
                if (gameState.detectionState !== 'far') {
                    gameState.detectionState = 'far';
                    gameState.stableTime = 0;
                    progressFill.style.width = '0%';
                    stateIndicator.textContent = 'è¯·è¿œç¦»';
                }
                
                gameState.lastDetectionState = 'far';
                sensorStatus.textContent = 'ç­‰å¾…é è¿‘';
            }
        }

        function onCycleComplete(brightness) {
            let points = CONFIG.SCORE_MULTIPLIER;
            let message = '';
            
            if (gameState.mode === 'timeAttack') {
                gameState.combo++;
                points = points * (1 + gameState.combo * 0.1);
                message = `+${Math.round(points)} è¿å‡»x${gameState.combo}`;
                soundSystem.playCombo();
            } else if (gameState.mode === 'endurance') {
                gameState.cycleCount++;
                points = 20;
                message = `å¾ªç¯ ${gameState.cycleCount}/${gameState.currentGameSettings.maxCycles}! +${points}`;
                soundSystem.playCycle();
            }
            
            // åŠ åˆ†
            gameState.score += Math.round(points);
            
            // è§†è§‰åé¦ˆ
            if (message) {
                showComboIndicator(message);
            }
            
            const sensorVisual = document.getElementById('sensorVisual');
            sensorVisual.classList.add('scoring');
            setTimeout(() => sensorVisual.classList.remove('scoring'), 300);
            
            // æ›´æ–°çŠ¶æ€
            gameState.lastDetectionState = 'near';
            
            updateDisplay();
        }

        function showComboIndicator(text) {
            const indicator = document.getElementById('comboIndicator');
            indicator.textContent = text;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        }

        function updateDisplay() {
            document.getElementById('gameScore').textContent = gameState.score;
            document.getElementById('timer').textContent = gameState.time;
            document.getElementById('combo').textContent = gameState.combo;
        }

        function updateSettingsInfo(brightness, isNear) {
            if (document.getElementById('settingsPanel').style.display === 'block') {
                document.getElementById('currentBrightness').textContent = brightness ? brightness.toFixed(1) : '-';
                document.getElementById('smoothedBrightness').textContent = brightness ? brightness.toFixed(1) : '-';
                document.getElementById('detectionStatus').textContent = isNear ? 'æ£€æµ‹åˆ°é è¿‘' : 'æœªæ£€æµ‹åˆ°';
                
                // æ›´æ–°äº®åº¦æ¡
                const brightnessPercent = Math.min((brightness / 255) * 100, 100);
                document.getElementById('brightnessFill').style.width = `${brightnessPercent}%`;
            }
        }

        // ===================================================================
        // è§¦ç¢°æ£€æµ‹åŠŸèƒ½
        // ===================================================================
        function startTouchDetection() {
            const touchOverlay = document.getElementById('touchOverlay');
            touchOverlay.classList.add('active');
            
            // è§¦æ‘¸å¼€å§‹
            touchOverlay.addEventListener('touchstart', (e) => {
                e.preventDefault();
                gameState.isTouching = true;
                handleDetection(true, 0);
            });
            
            // è§¦æ‘¸ç»“æŸ
            touchOverlay.addEventListener('touchend', (e) => {
                e.preventDefault();
                gameState.isTouching = false;
                handleDetection(false, 0);
            });
            
            // é¼ æ ‡äº‹ä»¶ï¼ˆç”¨äºæ¡Œé¢æµ‹è¯•ï¼‰
            touchOverlay.addEventListener('mousedown', (e) => {
                e.preventDefault();
                gameState.isTouching = true;
                handleDetection(true, 0);
            });
            
            touchOverlay.addEventListener('mouseup', (e) => {
                e.preventDefault();
                gameState.isTouching = false;
                handleDetection(false, 0);
            });
        }

        function stopTouchDetection() {
            const touchOverlay = document.getElementById('touchOverlay');
            touchOverlay.classList.remove('active');
            gameState.isTouching = false;
        }

        // ===================================================================
        // æ‘„åƒå¤´æ£€æµ‹åŠŸèƒ½
        // ===================================================================
        async function startDetection() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(CONFIG.VIDEO_CONSTRAINTS);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    isDetecting = true;
                    detectBrightness();
                };
            } catch (err) {
                console.error("æ— æ³•è®¿é—®æ‘„åƒå¤´: ", err);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                backToMenu();
            }
        }

        async function startDetectionForSettings() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(CONFIG.VIDEO_CONSTRAINTS);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    isDetecting = true;
                    detectBrightness();
                };
            } catch (err) {
                console.error("æ— æ³•è®¿é—®æ‘„åƒå¤´: ", err);
                document.getElementById('detectionStatus').textContent = 'æ‘„åƒå¤´è®¿é—®å¤±è´¥';
            }
        }

        function stopDetection() {
            isDetecting = false;
            if (detectionTimer) {
                clearTimeout(detectionTimer);
            }
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            brightnessHistory = [];
            stopTouchDetection();
        }

        function detectBrightness() {
            if (!isDetecting) return;
            
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const zoneWidth = canvas.width * CONFIG.DETECTION_ZONE_SIZE_RATIO;
            const zoneHeight = canvas.height * CONFIG.DETECTION_ZONE_SIZE_RATIO;
            const startX = (canvas.width - zoneWidth) / 2;
            const startY = (canvas.height - zoneHeight) / 2;
            
            const imageData = context.getImageData(startX, startY, zoneWidth, zoneHeight);
            const data = imageData.data;
            
            let totalBrightness = 0;
            const pixelCount = data.length / 4;
            
            for (let i = 0; i < pixelCount; i++) {
                const r = data[i * 4];
                const g = data[i * 4 + 1];
                const b = data[i * 4 + 2];
                const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
                totalBrightness += brightness;
            }
            
            const currentBrightness = totalBrightness / pixelCount;
            
            brightnessHistory.push(currentBrightness);
            if (brightnessHistory.length > CONFIG.AVERAGING_WINDOW_SIZE) {
                brightnessHistory.shift();
            }
            
            let smoothedBrightness = 0;
            for (const value of brightnessHistory) {
                smoothedBrightness += value;
            }
            smoothedBrightness /= brightnessHistory.length;
            
            // æ ¹æ®åè½¬è®¾ç½®åˆ¤æ–­æ˜¯å¦é è¿‘
            let isNear;
            if (CONFIG.INVERT_SENSOR) {
                // åè½¬æ¨¡å¼ï¼šäº®åº¦é«˜è¡¨ç¤ºé è¿‘
                isNear = smoothedBrightness > CONFIG.BRIGHTNESS_THRESHOLD && brightnessHistory.length >= CONFIG.AVERAGING_WINDOW_SIZE;
            } else {
                // æ­£å¸¸æ¨¡å¼ï¼šäº®åº¦ä½è¡¨ç¤ºé è¿‘
                isNear = smoothedBrightness < CONFIG.BRIGHTNESS_THRESHOLD && brightnessHistory.length >= CONFIG.AVERAGING_WINDOW_SIZE;
            }
            
            handleDetection(isNear, smoothedBrightness);
            
            detectionTimer = setTimeout(detectBrightness, CONFIG.CHECK_INTERVAL);
        }

        // ===================================================================
        // å…¨å±åŠŸèƒ½
        // ===================================================================
        function requestFullscreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) {
                elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
                elem.webkitRequestFullscreen();
            } else if (elem.msRequestFullscreen) {
                elem.msRequestFullscreen();
            }
        }

        // ===================================================================
        // åˆå§‹åŒ–
        // ===================================================================
        function init() {
            initDOM();
            createParticles();
            loadSettings();
            updateDisplay();
            
            // è®¾ç½®æ»‘å—äº‹ä»¶
            document.getElementById('thresholdSlider').addEventListener('input', function() {
                document.getElementById('thresholdValue').textContent = this.value;
            });
            
            document.getElementById('stableTimeSlider').addEventListener('input', function() {
                document.getElementById('stableTimeValue').textContent = this.value;
            });
        }

        function loadSettings() {
            const savedThreshold = getCookie('brightnessThreshold');
            const savedStableTime = getCookie('requiredStableTime');
            const savedInvertSensor = getCookie('invertSensor');
            const savedAutoFullscreen = getCookie('autoFullscreen');
            const savedSensorMode = getCookie('sensorMode');
            
            if (savedThreshold) {
                CONFIG.BRIGHTNESS_THRESHOLD = parseInt(savedThreshold);
            }
            if (savedStableTime) {
                CONFIG.requiredStableTime = parseInt(savedStableTime);
            }
            if (savedInvertSensor !== null) {
                CONFIG.INVERT_SENSOR = savedInvertSensor === 'true';
            }
            if (savedAutoFullscreen !== null) {
                CONFIG.AUTO_FULLSCREEN = savedAutoFullscreen === 'true';
            }
            if (savedSensorMode) {
                CONFIG.SENSOR_MODE = savedSensorMode;
                document.getElementById('currentModeText').textContent = 
                    CONFIG.SENSOR_MODE === 'light' ? 'å…‰æ„Ÿæ¨¡å¼' : 'è§¦ç¢°æ¨¡å¼';
            }
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 4 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                particlesContainer.appendChild(particle);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é è¿‘æŒ‘æˆ˜ - äº’åŠ¨æ„Ÿåº”æ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            overflow-x: hidden;
        }

        /* éšè—çš„æ‘„åƒå¤´å…ƒç´  */
        #video, #canvas {
            display: none;
        }

        /* å¤´éƒ¨ä¿¡æ¯æ  */
        header {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .game-title {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(45deg, #f093fb, #f5576c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* ä¸»æ¸¸æˆåŒºåŸŸ */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        /* æ¸¸æˆæ¨¡å¼é€‰æ‹©ç•Œé¢ */
        .mode-selection {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
        }

        .mode-selection h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .mode-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .mode-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            padding: 20px;
            border-radius: 15px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .mode-btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .mode-btn:hover:before {
            left: 100%;
        }

        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .mode-description {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 5px;
        }

        /* è®¾ç½®ç•Œé¢ */
        .settings-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeIn 0.5s ease-out;
            display: none;
        }

        .settings-panel h2 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
        }

        .setting-item {
            margin-bottom: 25px;
        }

        .setting-label {
            display: block;
            margin-bottom: 10px;
            font-size: 16px;
            opacity: 0.9;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .slider {
            flex: 1;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.3);
            outline: none;
            transition: opacity 0.2s;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #ffd700;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .slider-value {
            min-width: 50px;
            text-align: center;
            font-weight: bold;
            color: #ffd700;
        }

        .sensor-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .sensor-info h3 {
            margin-bottom: 15px;
            font-size: 18px;
            color: #ffd700;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .info-label {
            opacity: 0.8;
        }

        .info-value {
            font-weight: bold;
            color: #4caf50;
        }

        .brightness-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .brightness-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-area {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            animation: fadeIn 0.5s ease-out;
        }

        .sensor-visual {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 3px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            transition: all 0.3s ease;
        }

        .sensor-visual.near {
            border-color: #4caf50;
            box-shadow: 0 0 30px rgba(76, 175, 80, 0.6);
            animation: pulse 1s infinite;
        }

        .sensor-visual.far {
            border-color: #2196f3;
            box-shadow: 0 0 30px rgba(33, 150, 243, 0.6);
        }

        .sensor-visual.scoring {
            border-color: #ffd700;
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.8);
            transform: scale(1.1);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .sensor-status {
            font-size: 18px;
            text-align: center;
        }

        .state-indicator {
            margin-top: 10px;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            font-size: 14px;
        }

        .progress-bar {
            width: 300px;
            height: 30px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 15px;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .combo-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
            opacity: 0;
            pointer-events: none;
        }

        .combo-indicator.show {
            animation: comboPopup 1s ease-out;
        }

        @keyframes comboPopup {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .control-btn.primary {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            border: none;
        }

        /* æ¸¸æˆç»“æŸç•Œé¢ */
        .game-over {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            animation: fadeIn 0.5s ease-out;
        }

        .game-over h2 {
            font-size: 36px;
            margin-bottom: 20px;
            color: #ffd700;
        }

        .final-score {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .high-score {
            font-size: 18px;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        /* åŠ¨ç”» */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ç²’å­æ•ˆæœ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            animation: float 10s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0) translateX(0);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) translateX(100px);
                opacity: 0;
            }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .header-content {
                justify-content: center;
            }

            .stats {
                gap: 20px;
            }

            .stat-value {
                font-size: 24px;
            }

            .mode-selection, .settings-panel {
                padding: 30px 20px;
            }

            .sensor-visual {
                width: 150px;
                height: 150px;
            }

            .progress-bar {
                width: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- éšè—çš„æ‘„åƒå¤´å…ƒç´  -->
    <video id="video" width="640" height="480" autoplay></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <!-- ç²’å­èƒŒæ™¯ -->
    <div class="particles" id="particles"></div>

    <!-- å¤´éƒ¨ä¿¡æ¯ -->
    <header>
        <div class="header-content">
            <h1 class="game-title">ğŸ® é è¿‘æŒ‘æˆ˜</h1>
            <div class="stats">
                <div class="stat-item">
                    <span class="stat-label">åˆ†æ•°</span>
                    <span class="stat-value" id="score">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">æ—¶é—´</span>
                    <span class="stat-value" id="timer">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">è¿å‡»</span>
                    <span class="stat-value" id="combo">0</span>
                </div>
            </div>
        </div>
    </header>

    <!-- ä¸»æ¸¸æˆåŒºåŸŸ -->
    <main>
        <!-- æ¸¸æˆæ¨¡å¼é€‰æ‹© -->
        <section class="mode-selection" id="modeSelection">
            <h2>é€‰æ‹©æ¸¸æˆæ¨¡å¼</h2>
            <div class="mode-buttons">
                <button class="mode-btn" onclick="showSettings()">
                    âš™ï¸ æ¸¸æˆè®¾ç½®
                    <div class="mode-description">è°ƒæ•´æ£€æµ‹é˜ˆå€¼å’ŒæŸ¥çœ‹å®æ—¶æ„Ÿå…‰ä¿¡æ¯</div>
                </button>
                <button class="mode-btn" onclick="startGame('timeAttack')">
                    â±ï¸ é™æ—¶æŒ‘æˆ˜
                    <div class="mode-description">åœ¨60ç§’å†…è·å¾—å°½å¯èƒ½é«˜çš„åˆ†æ•°</div>
                </button>
                <button class="mode-btn" onclick="startGame('endurance')">
                    ğŸ’ª è€åŠ›æ¨¡å¼
                    <div class="mode-description">ä¿æŒé è¿‘-è¿œç¦»å¾ªç¯ï¼Œçœ‹ä½ èƒ½åšæŒå¤šä¹…</div>
                </button>
                <button class="mode-btn" onclick="startGame('precision')">
                    ğŸ¯ ç²¾å‡†æ§åˆ¶
                    <div class="mode-description">ç²¾ç¡®æ§åˆ¶é è¿‘è·ç¦»ï¼Œè·å¾—æ›´é«˜åˆ†æ•°</div>
                </button>
            </div>
        </section>

        <!-- è®¾ç½®ç•Œé¢ -->
        <section class="settings-panel" id="settingsPanel">
            <h2>âš™ï¸ æ¸¸æˆè®¾ç½®</h2>
            
            <div class="setting-item">
                <label class="setting-label">é è¿‘é˜ˆå€¼ (äº®åº¦å€¼è¶Šä½è¶Šæ•æ„Ÿ)</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="thresholdSlider" min="30" max="150" value="90">
                    <span class="slider-value" id="thresholdValue">90</span>
                </div>
            </div>

            <div class="setting-item">
                <label class="setting-label">ç¨³å®šæ—¶é—´ (æ¯«ç§’)</label>
                <div class="slider-container">
                    <input type="range" class="slider" id="stableTimeSlider" min="300" max="2000" value="1000" step="100">
                    <span class="slider-value" id="stableTimeValue">1000</span>
                </div>
            </div>

            <div class="sensor-info">
                <h3>ğŸ“Š å®æ—¶æ„Ÿå…‰ä¿¡æ¯</h3>
                <div class="info-row">
                    <span class="info-label">å½“å‰äº®åº¦:</span>
                    <span class="info-value" id="currentBrightness">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">å¹³æ»‘äº®åº¦:</span>
                    <span class="info-value" id="smoothedBrightness">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">æ£€æµ‹çŠ¶æ€:</span>
                    <span class="info-value" id="detectionStatus">æœªå¼€å§‹</span>
                </div>
                <div class="brightness-bar">
                    <div class="brightness-fill" id="brightnessFill"></div>
                </div>
            </div>

            <div class="controls">
                <button class="control-btn primary" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                <button class="control-btn" onclick="backToMenu()">è¿”å›èœå•</button>
            </div>
        </section>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <section class="game-area" id="gameArea">
            <div class="sensor-visual" id="sensorVisual">
                <div>
                    <div class="sensor-status" id="sensorStatus">å‡†å¤‡å°±ç»ª</div>
                    <div class="state-indicator" id="stateIndicator">ç­‰å¾…é è¿‘</div>
                </div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="combo-indicator" id="comboIndicator"></div>

            <div class="controls">
                <button class="control-btn" onclick="pauseGame()">æš‚åœ</button>
                <button class="control-btn primary" onclick="backToMenu()">è¿”å›èœå•</button>
            </div>
        </section>

        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <section class="game-over" id="gameOver">
            <h2>æ¸¸æˆç»“æŸï¼</h2>
            <div class="final-score" id="finalScore">0</div>
            <div class="high-score" id="highScore">æœ€é«˜åˆ†: 0</div>
            <div class="controls">
                <button class="control-btn primary" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
                <button class="control-btn" onclick="backToMenu()">è¿”å›èœå•</button>
            </div>
        </section>
    </main>

    <script>
        // ===================================================================
        // æ¸¸æˆé…ç½®å’ŒçŠ¶æ€
        // ===================================================================
        let CONFIG = {
            // äº®åº¦æ£€æµ‹é…ç½®
            BRIGHTNESS_THRESHOLD: 90,
            AVERAGING_WINDOW_SIZE: 10,
            CHECK_INTERVAL: 100,
            DETECTION_ZONE_SIZE_RATIO: 0.5,
            VIDEO_CONSTRAINTS: {
                video: {
                    facingMode: 'user',
                    focusMode: 'manual'
                }
            },
            // æ¸¸æˆé…ç½®
            SCORE_MULTIPLIER: 10,
            COMBO_TIMEOUT: 2000,
            PRECISION_ZONES: [
                { threshold: 60, multiplier: 3, name: 'å®Œç¾' },
                { threshold: 80, multiplier: 2, name: 'ä¼˜ç§€' },
                { threshold: 100, multiplier: 1, name: 'è‰¯å¥½' }
            ]
        };

        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            mode: null,
            isPlaying: false,
            isPaused: false,
            score: 0,
            combo: 0,
            time: 0,
            highScore: localStorage.getItem('highScore') || 0,
            lastScoreTime: 0,
            detectionState: 'waiting', // waiting, near, far
            stableTime: 0,
            requiredStableTime: 1000,
            lastDetectionState: null,
            cycleCount: 0
        };

        // æ‘„åƒå¤´ç›¸å…³å˜é‡
        let video, canvas, context;
        let isDetecting = false;
        let brightnessHistory = [];

        // å®šæ—¶å™¨
        let gameTimer = null;
        let detectionTimer = null;

        // éŸ³æ•ˆç³»ç»Ÿ
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.initialized = false;
            }

            init() {
                if (this.initialized) return;
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                this.initialized = true;
            }

            playSound(frequency, duration, type = 'sine') {
                if (!this.initialized) return;
                
                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = type;
                
                gainNode.gain.setValueAtTime(0.3, this.audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, this.audioContext.currentTime + duration);
                
                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }

            playScore() {
                this.playSound(523, 0.1); // C5
                setTimeout(() => this.playSound(659, 0.1), 100); // E5
                setTimeout(() => this.playSound(784, 0.2), 200); // G5
            }

            playCombo() {
                this.playSound(440, 0.1); // A4
                setTimeout(() => this.playSound(554, 0.1), 50); // C#5
                setTimeout(() => this.playSound(659, 0.1), 100); // E5
            }

            playCycle() {
                this.playSound(330, 0.15); // E4
                setTimeout(() => this.playSound(440, 0.15), 150); // A4
            }
        }

        const soundSystem = new SoundSystem();

        // ===================================================================
        // DOMå…ƒç´ 
        // ===================================================================
        function initDOM() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
        }

        // ===================================================================
        // æ¸¸æˆæ§åˆ¶å‡½æ•°
        // ===================================================================
        function showSettings() {
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'block';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
            
            // åŠ è½½å½“å‰è®¾ç½®
            document.getElementById('thresholdSlider').value = CONFIG.BRIGHTNESS_THRESHOLD;
            document.getElementById('thresholdValue').textContent = CONFIG.BRIGHTNESS_THRESHOLD;
            document.getElementById('stableTimeSlider').value = CONFIG.requiredStableTime;
            document.getElementById('stableTimeValue').textContent = CONFIG.requiredStableTime;
            
            // å¯åŠ¨æ£€æµ‹ä»¥æ˜¾ç¤ºå®æ—¶ä¿¡æ¯
            startDetectionForSettings();
        }

        function saveSettings() {
            CONFIG.BRIGHTNESS_THRESHOLD = parseInt(document.getElementById('thresholdSlider').value);
            CONFIG.requiredStableTime = parseInt(document.getElementById('stableTimeSlider').value);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('brightnessThreshold', CONFIG.BRIGHTNESS_THRESHOLD);
            localStorage.setItem('requiredStableTime', CONFIG.requiredStableTime);
            
            backToMenu();
        }

        function startGame(mode) {
            // åˆå§‹åŒ–éŸ³æ•ˆç³»ç»Ÿ
            soundSystem.init();
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            gameState.mode = mode;
            gameState.isPlaying = true;
            gameState.isPaused = false;
            gameState.score = 0;
            gameState.combo = 0;
            gameState.time = mode === 'timeAttack' ? 60 : 0;
            gameState.detectionState = 'waiting';
            gameState.stableTime = 0;
            gameState.cycleCount = 0;
            
            // æ ¹æ®æ¨¡å¼è®¾ç½®å‚æ•°
            switch(mode) {
                case 'timeAttack':
                    break;
                case 'endurance':
                    break;
                case 'precision':
                    break;
            }
            
            // åˆ‡æ¢ç•Œé¢
            document.getElementById('modeSelection').style.display = 'none';
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('gameArea').style.display = 'flex';
            document.getElementById('gameOver').style.display = 'none';
            
            // æ›´æ–°æ˜¾ç¤º
            updateDisplay();
            
            // å¯åŠ¨æ‘„åƒå¤´å’Œæ£€æµ‹
            startDetection();
            
            // å¯åŠ¨æ¸¸æˆè®¡æ—¶å™¨
            startGameTimer();
        }

        function pauseGame() {
            if (!gameState.isPlaying) return;
            
            gameState.isPaused = !gameState.isPaused;
            
            if (gameState.isPaused) {
                clearInterval(gameTimer);
                document.querySelector('.control-btn').textContent = 'ç»§ç»­';
            } else {
                startGameTimer();
                document.querySelector('.control-btn').textContent = 'æš‚åœ';
            }
        }

        function endGame() {
            gameState.isPlaying = false;
            
            // åœæ­¢æ‰€æœ‰è®¡æ—¶å™¨
            clearInterval(gameTimer);
            stopDetection();
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (gameState.score > gameState.highScore) {
                gameState.highScore = gameState.score;
                localStorage.setItem('highScore', gameState.highScore);
            }
            
            // æ˜¾ç¤ºç»“æŸç•Œé¢
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameOver').style.display = 'block';
            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('highScore').textContent = `æœ€é«˜åˆ†: ${gameState.highScore}`;
        }

        function restartGame() {
            startGame(gameState.mode);
        }

        function backToMenu() {
            gameState.isPlaying = false;
            clearInterval(gameTimer);
            stopDetection();
            
            document.getElementById('modeSelection').style.display = 'block';
            document.getElementById('settingsPanel').style.display = 'none';
            document.getElementById('gameArea').style.display = 'none';
            document.getElementById('gameOver').style.display = 'none';
        }

        // ===================================================================
        // æ¸¸æˆé€»è¾‘
        // ===================================================================
        function startGameTimer() {
            gameTimer = setInterval(() => {
                if (gameState.isPaused) return;
                
                switch(gameState.mode) {
                    case 'timeAttack':
                        gameState.time--;
                        if (gameState.time <= 0) {
                            endGame();
                        }
                        break;
                    case 'endurance':
                        gameState.time++;
                        break;
                    case 'precision':
                        gameState.time++;
                        break;
                }
                
                updateDisplay();
            }, 1000);
        }

        function handleDetection(isNear, brightness) {
            const sensorVisual = document.getElementById('sensorVisual');
            const sensorStatus = document.getElementById('sensorStatus');
            const stateIndicator = document.getElementById('stateIndicator');
            const progressFill = document.getElementById('progressFill');
            
            // æ›´æ–°è®¾ç½®ç•Œé¢çš„å®æ—¶ä¿¡æ¯
            updateSettingsInfo(brightness, isNear);
            
            if (!gameState.isPlaying || gameState.isPaused) return;
            
            if (isNear) {
                sensorVisual.classList.remove('far');
                sensorVisual.classList.add('near');
                
                if (gameState.detectionState !== 'near') {
                    gameState.detectionState = 'near';
                    gameState.stableTime = 0;
                    
                    // æ£€æŸ¥æ˜¯å¦å®Œæˆäº†è¿œç¦»-é è¿‘çš„å¾ªç¯
                    if (gameState.lastDetectionState === 'far') {
                        onCycleComplete(brightness);
                    }
                    
                    stateIndicator.textContent = 'ä¿æŒé è¿‘';
                }
                
                gameState.stableTime += CONFIG.CHECK_INTERVAL;
                const progress = Math.min(gameState.stableTime / CONFIG.requiredStableTime, 1);
                progressFill.style.width = `${progress * 100}%`;
                sensorStatus.textContent = 'æ£€æµ‹ä¸­...';
                
            } else {
                sensorVisual.classList.remove('near');
                sensorVisual.classList.add('far');
                
                if (gameState.detectionState !== 'far') {
                    gameState.detectionState = 'far';
                    gameState.stableTime = 0;
                    progressFill.style.width = '0%';
                    stateIndicator.textContent = 'è¯·è¿œç¦»';
                }
                
                gameState.lastDetectionState = 'far';
                sensorStatus.textContent = 'ç­‰å¾…é è¿‘';
            }
        }

        function onCycleComplete(brightness) {
            let points = CONFIG.SCORE_MULTIPLIER;
            let message = '';
            
            switch(gameState.mode) {
                case 'timeAttack':
                    gameState.combo++;
                    points = points * (1 + gameState.combo * 0.1);
                    message = `+${Math.round(points)} è¿å‡»x${gameState.combo}`;
                    soundSystem.playCombo();
                    break;
                    
                case 'endurance':
                    gameState.cycleCount++;
                    points = 20;
                    message = `å¾ªç¯å®Œæˆ! +${points}`;
                    soundSystem.playCycle();
                    break;
                    
                case 'precision':
                    for (const zone of CONFIG.PRECISION_ZONES) {
                        if (brightness < zone.threshold) {
                            points = points * zone.multiplier;
                            message = `${zone.name}! x${zone.multiplier}`;
                            break;
                        }
                    }
                    soundSystem.playScore();
                    break;
            }
            
            // åŠ åˆ†
            gameState.score += Math.round(points);
            
            // è§†è§‰åé¦ˆ
            if (message) {
                showComboIndicator(message);
            }
            
            const sensorVisual = document.getElementById('sensorVisual');
            sensorVisual.classList.add('scoring');
            setTimeout(() => sensorVisual.classList.remove('scoring'), 300);
            
            // æ›´æ–°çŠ¶æ€
            gameState.lastDetectionState = 'near';
            
            updateDisplay();
        }

        function showComboIndicator(text) {
            const indicator = document.getElementById('comboIndicator');
            indicator.textContent = text;
            indicator.classList.add('show');
            
            setTimeout(() => {
                indicator.classList.remove('show');
            }, 1000);
        }

        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('timer').textContent = gameState.time;
            document.getElementById('combo').textContent = gameState.combo;
        }

        function updateSettingsInfo(brightness, isNear) {
            if (document.getElementById('settingsPanel').style.display === 'block') {
                document.getElementById('currentBrightness').textContent = brightness ? brightness.toFixed(1) : '-';
                document.getElementById('smoothedBrightness').textContent = brightness ? brightness.toFixed(1) : '-';
                document.getElementById('detectionStatus').textContent = isNear ? 'æ£€æµ‹åˆ°é è¿‘' : 'æœªæ£€æµ‹åˆ°';
                
                // æ›´æ–°äº®åº¦æ¡
                const brightnessPercent = Math.min((brightness / 255) * 100, 100);
                document.getElementById('brightnessFill').style.width = `${brightnessPercent}%`;
            }
        }

        // ===================================================================
        // æ‘„åƒå¤´æ£€æµ‹åŠŸèƒ½
        // ===================================================================
        async function startDetection() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(CONFIG.VIDEO_CONSTRAINTS);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    isDetecting = true;
                    detectBrightness();
                };
            } catch (err) {
                console.error("æ— æ³•è®¿é—®æ‘„åƒå¤´: ", err);
                alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
                backToMenu();
            }
        }

        async function startDetectionForSettings() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia(CONFIG.VIDEO_CONSTRAINTS);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    isDetecting = true;
                    detectBrightness();
                };
            } catch (err) {
                console.error("æ— æ³•è®¿é—®æ‘„åƒå¤´: ", err);
                document.getElementById('detectionStatus').textContent = 'æ‘„åƒå¤´è®¿é—®å¤±è´¥';
            }
        }

        function stopDetection() {
            isDetecting = false;
            if (detectionTimer) {
                clearTimeout(detectionTimer);
            }
            
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            
            brightnessHistory = [];
        }

        function detectBrightness() {
            if (!isDetecting) return;
            
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const zoneWidth = canvas.width * CONFIG.DETECTION_ZONE_SIZE_RATIO;
            const zoneHeight = canvas.height * CONFIG.DETECTION_ZONE_SIZE_RATIO;
            const startX = (canvas.width - zoneWidth) / 2;
            const startY = (canvas.height - zoneHeight) / 2;
            
            const imageData = context.getImageData(startX, startY, zoneWidth, zoneHeight);
            const data = imageData.data;
            
            let totalBrightness = 0;
            const pixelCount = data.length / 4;
            
            for (let i = 0; i < pixelCount; i++) {
                const r = data[i * 4];
                const g = data[i * 4 + 1];
                const b = data[i * 4 + 2];
                const brightness = 0.299 * r + 0.587 * g + 0.114 * b;
                totalBrightness += brightness;
            }
            
            const currentBrightness = totalBrightness / pixelCount;
            
            brightnessHistory.push(currentBrightness);
            if (brightnessHistory.length > CONFIG.AVERAGING_WINDOW_SIZE) {
                brightnessHistory.shift();
            }
            
            let smoothedBrightness = 0;
            for (const value of brightnessHistory) {
                smoothedBrightness += value;
            }
            smoothedBrightness /= brightnessHistory.length;
            
            const isNear = smoothedBrightness < CONFIG.BRIGHTNESS_THRESHOLD && brightnessHistory.length >= CONFIG.AVERAGING_WINDOW_SIZE;
            
            handleDetection(isNear, smoothedBrightness);
            
            detectionTimer = setTimeout(detectBrightness, CONFIG.CHECK_INTERVAL);
        }

        // ===================================================================
        // åˆå§‹åŒ–
        // ===================================================================
        function init() {
            initDOM();
            createParticles();
            loadSettings();
            updateDisplay();
            
            // è®¾ç½®æ»‘å—äº‹ä»¶
            document.getElementById('thresholdSlider').addEventListener('input', function() {
                document.getElementById('thresholdValue').textContent = this.value;
            });
            
            document.getElementById('stableTimeSlider').addEventListener('input', function() {
                document.getElementById('stableTimeValue').textContent = this.value;
            });
        }

        function loadSettings() {
            const savedThreshold = localStorage.getItem('brightnessThreshold');
            const savedStableTime = localStorage.getItem('requiredStableTime');
            
            if (savedThreshold) {
                CONFIG.BRIGHTNESS_THRESHOLD = parseInt(savedThreshold);
            }
            if (savedStableTime) {
                CONFIG.requiredStableTime = parseInt(savedStableTime);
            }
        }

        function createParticles() {
            const particlesContainer = document.getElementById('particles');
            for (let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 4 + 2}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 10}s`;
                particle.style.animationDuration = `${Math.random() * 10 + 10}s`;
                particlesContainer.appendChild(particle);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
